<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>受発注管理ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* Simple transition for collapsible filter */
      .filter-content, .expandable-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out;
      }
      .filter-content.open, .expandable-content.open {
        max-height: 600px; /* Adjust as needed */
      }
      .expandable-content {
        transition: max-height 0.3s ease-in-out;
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useMemo, useCallback, useEffect } = React;

      // --- CONSTANTS ---
      const TASKS = [
        'ネゴ提案', '見積提示', '注文作成', '本社発注', '日程調整',
        '現地調整', '検収作成', '検収送付', '保守作成', '保守送付'
      ];
      const CUSTOMER_CATEGORIES = ['会計事務所', '関与先'];
      const DIVISIONS = ['新規', 'リプレイス', 'その他'];
      const PRODUCT_TYPES = ['PC', 'サーバー', 'ソフトウェア', 'その他'];
      const PAYMENT_TYPES = ['一括', '分割', 'リース', 'COD'];
      const SETUP_OPTIONS = ['あり', 'なし', 'あり (SCG)'];
      const MAINTENANCE_OPTIONS = ['あり', 'なし'];
      const STATUS_OPTIONS = ['すべて', '進行中', '完了'];
      const SORT_OPTIONS = {
        'registrationDate_asc': '登録日が古い順',
        'registrationDate_desc': '登録日が新しい順',
        'mainAmount_desc': '金額が高い順',
        'mainAmount_asc': '金額が低い順',
      };
      
      const JAPANESE_HOLIDAYS = new Set([
        // 2025
        '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-24', '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13', '2025-11-03', '2025-11-24',
        // 2026
        '2026-01-01', '2026-01-12', '2026-02-11', '2026-02-23', '2026-03-20', '2026-04-29', '2026-05-03', '2026-05-04', '2026-05-05', '2026-05-6', '2026-07-20', '2026-08-11', '2026-09-21', '2026-09-22', '2026-09-23', '2026-10-12', '2026-11-03', '2026-11-23',
        // Add more years as needed
      ]);

      // --- ICONS ---
      const PlusIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>);
      const XIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>);
      const ChevronUpIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>);
      const CheckIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}><path fillRule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clipRule="evenodd" /></svg>);
      const EditIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>);
      const TrashIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.033-2.134H8.033C6.91 2.75 6 3.704 6 4.884v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>);
      const ArrowCircleRightIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>);

      // --- HOOKS ---
      const usePeriodCalculator = () => {
          const generatePeriods = () => {
              const periods = [];
              const startYear = 2025; // R7
              const startPeriod = 60;
              for (let i = 0; i < 5; i++) {
                  const year = startYear + i;
                  const period = startPeriod + i;
                  const reiwaYear = year - 2018;
                  // 上期 (First Half): Oct to Mar
                  periods.push({
                      label: `第${period}期 上期 (令和${reiwaYear}年10月～令和${reiwaYear + 1}年3月)`,
                      value: `${period}-1`,
                      endDate: new Date(year + 1, 2, 31),
                  });
                  // 下期 (Second Half): Apr to Sep
                  periods.push({
                      label: `第${period}期 下期 (令和${reiwaYear + 1}年4月～令和${reiwaYear + 1}年9月)`,
                      value: `${period}-2`,
                      endDate: new Date(year + 1, 8, 30),
                  });
              }
              return periods;
          };

          const allPeriods = useMemo(generatePeriods, []);
          const [selectedPeriod, setSelectedPeriod] = useState(allPeriods[0].value);
          
          const calculateBusinessDays = useCallback((endDate) => {
              let count = 0;
              const curDate = new Date();
              if(curDate > endDate) return 0;
              
              while (curDate <= endDate) {
                  const dayOfWeek = curDate.getDay();
                  const dateString = curDate.toISOString().split('T')[0];
                  if (dayOfWeek !== 0 && dayOfWeek !== 6 && !JAPANESE_HOLIDAYS.has(dateString)) {
                      count++;
                  }
                  curDate.setDate(curDate.getDate() + 1);
              }
              return count;
          }, []);

          const remainingBusinessDays = useMemo(() => {
              const period = allPeriods.find(p => p.value === selectedPeriod);
              return period ? calculateBusinessDays(period.endDate) : 0;
          }, [selectedPeriod, allPeriods, calculateBusinessDays]);

          return { periods: allPeriods, selectedPeriod, setSelectedPeriod, remainingBusinessDays };
      }

      // --- COMPONENTS ---
      const Input = (props) => <input {...props} className="block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const Select = (props) => <select {...props} className="block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const Label = ({htmlFor, children}) => <label htmlFor={htmlFor} className="block text-sm font-medium text-slate-700 mb-1">{children}</label>;

      const NewProjectModal = ({ isOpen, onClose, onSaveProject, editingProject }) => {
        const isEditMode = !!editingProject;

        const getInitialState = () => {
            if (isEditMode) return { ...editingProject };
            return {
                category: CUSTOMER_CATEGORIES[0], clientName: '', registrationDate: new Date().toISOString().split('T')[0],
                mainAmount: 0, projectName: '', division: DIVISIONS[0], productType: PRODUCT_TYPES[0],
                paymentType: PAYMENT_TYPES[0], setup: SETUP_OPTIONS[1], maintenance: MAINTENANCE_OPTIONS[1], memo: ''
            };
        };

        const [formState, setFormState] = useState(getInitialState());
        const [step, setStep] = useState(1);
        
        useEffect(() => { 
            if (isOpen) {
                const initialState = getInitialState();
                setFormState(initialState);
                setStep(isEditMode ? 2 : 1);
            }
        }, [isOpen, editingProject]);
        
        const handleCategorySelect = (category) => {
            setFormState(prev => ({...prev, category}));
            setStep(2);
        };

        const handleChange = (e) => {
            const { name, value, type } = e.target;
            setFormState(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!formState.projectName || !formState.clientName) { alert('顧客名と案件名は必須です。'); return; }
            onSaveProject(formState); 
            onClose();
        };

        if (!isOpen) return null;
        
        const ModalInput = (props) => <input {...props} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
        const ModalSelect = (props) => <select {...props} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
        const ModalTextarea = (props) => <textarea {...props} rows="3" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
        const ModalLabel = ({htmlFor, children}) => <label htmlFor={htmlFor} className="block text-sm font-medium text-slate-700">{children}</label>;

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" onClick={onClose}>
                {step === 1 && !isEditMode && (
                     <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all p-8 text-center" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-slate-800 mb-2">新規案件の登録</h3>
                        <p className="text-slate-600 mb-8">まず、顧客種別を選択してください</p>
                        <div className="flex justify-center gap-4">
                            <button onClick={() => handleCategorySelect(CUSTOMER_CATEGORIES[0])} className="w-40 h-16 text-lg font-semibold text-blue-600 bg-blue-50 border-2 border-blue-500 rounded-lg hover:bg-blue-100 transition-colors">{CUSTOMER_CATEGORIES[0]}</button>
                            <button onClick={() => handleCategorySelect(CUSTOMER_CATEGORIES[1])} className="w-40 h-16 text-lg font-semibold text-blue-600 bg-blue-50 border-2 border-blue-500 rounded-lg hover:bg-blue-100 transition-colors">{CUSTOMER_CATEGORIES[1]}</button>
                        </div>
                    </div>
                )}
                {step === 2 && (
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-slate-200 flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800">{isEditMode ? '案件の編集' : '新規案件の登録'}</h3><button onClick={onClose} className="p-1 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><XIcon className="w-5 h-5" /></button></div>
                        <form onSubmit={handleSubmit}>
                            <div className="p-6 max-h-[70vh] overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <div><ModalLabel htmlFor="category">顧客種別</ModalLabel><ModalSelect name="category" id="category" value={formState.category} onChange={handleChange}>{CUSTOMER_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="clientName">顧客名 <span className="text-red-500">*</span></ModalLabel><ModalInput type="text" name="clientName" id="clientName" value={formState.clientName} onChange={handleChange} required /></div>
                                <div><ModalLabel htmlFor="registrationDate">登録日</ModalLabel><ModalInput type="date" name="registrationDate" id="registrationDate" value={formState.registrationDate} onChange={handleChange} /></div>
                                <div><ModalLabel htmlFor="mainAmount">本体金額 (税抜)</ModalLabel><ModalInput type="number" name="mainAmount" id="mainAmount" value={formState.mainAmount} onChange={handleChange} /></div>
                                <div className="md:col-span-2"><ModalLabel htmlFor="projectName">案件名 <span className="text-red-500">*</span></ModalLabel><ModalInput type="text" name="projectName" id="projectName" value={formState.projectName} onChange={handleChange} required /></div>
                                <div><ModalLabel htmlFor="division">区分</ModalLabel><ModalSelect name="division" id="division" value={formState.division} onChange={handleChange}>{DIVISIONS.map(d => <option key={d}>{d}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="productType">商品種別</ModalLabel><ModalSelect name="productType" id="productType" value={formState.productType} onChange={handleChange}>{PRODUCT_TYPES.map(p => <option key={p}>{p}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="paymentType">支払区分</ModalLabel><ModalSelect name="paymentType" id="paymentType" value={formState.paymentType} onChange={handleChange}>{PAYMENT_TYPES.map(p => <option key={p}>{p}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="setup">セットアップ</ModalLabel><ModalSelect name="setup" id="setup" value={formState.setup} onChange={handleChange}>{SETUP_OPTIONS.map(s => <option key={s}>{s}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="maintenance">保守契約</ModalLabel><ModalSelect name="maintenance" id="maintenance" value={formState.maintenance} onChange={handleChange}>{MAINTENANCE_OPTIONS.map(m => <option key={m}>{m}</option>)}</ModalSelect></div>
                                <div className="md:col-span-2"><ModalLabel htmlFor="memo">メモ</ModalLabel><ModalTextarea name="memo" id="memo" value={formState.memo} onChange={handleChange} /></div>
                            </div>
                            <div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end items-center space-x-3"><button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">キャンセル</button><button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 transition">{isEditMode ? '更新する' : '登録する'}</button></div>
                        </form>
                    </div>
                )}
            </div>
        );
      };
      
      const ProjectTable = ({ projects, onTaskToggle, onEdit, onDelete, onCarryOver }) => {
        const [expandedId, setExpandedId] = useState(null);

        const ProjectDetailView = ({ project, onEdit, onDelete, onCarryOver }) => {
            const DetailItem = ({ label, value }) => (<div className="flex flex-col"><dt className="text-xs text-slate-500">{label}</dt><dd className="text-sm text-slate-900 mt-1">{value || 'ー'}</dd></div>);
            return (
                <div className="bg-slate-50/70 p-6">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-y-6 gap-x-4 mb-6">
                        <DetailItem label="顧客種別" value={project.category} />
                        <DetailItem label="区分" value={project.division} />
                        <DetailItem label="支払区分" value={project.paymentType} />
                        <DetailItem label="商品種別" value={project.productType} />
                        <DetailItem label="セットアップ" value={project.setup} />
                        <DetailItem label="保守契約" value={project.maintenance} />
                        <DetailItem label="登録日" value={new Date(project.registrationDate).toLocaleDateString('ja-JP')} />
                        <div className="flex flex-col">
                           <dt className="text-xs text-slate-500">金額内訳</dt>
                           <dd className="text-sm text-slate-900 mt-1">
                                <div>本体: {project.mainAmount.toLocaleString()}円</div>
                                <div>セットアップ: 0円</div>
                                <div>合計: {project.mainAmount.toLocaleString()}円</div>
                           </dd>
                        </div>
                         <div className="col-span-2 md:col-span-4"><DetailItem label="メモ" value={project.memo} /></div>
                    </div>
                    <div className="flex items-center gap-4 text-slate-600">
                        <button onClick={() => onEdit(project)} className="flex items-center gap-2 hover:text-blue-600"><EditIcon className="w-5 h-5" /><span>編集</span></button>
                        <button onClick={() => onDelete(project.id)} className="flex items-center gap-2 hover:text-red-600"><TrashIcon className="w-5 h-5" /><span>削除</span></button>
                        <button onClick={() => onCarryOver(project)} className="flex items-center gap-2 hover:text-green-600"><ArrowCircleRightIcon className="w-5 h-5" /><span>繰り越し</span></button>
                    </div>
                </div>
            );
        };

        const ProjectCard = ({ project, onTaskToggle, onEdit, onDelete, onCarryOver }) => {
            const nextTaskIndex = TASKS.findIndex(task => !project.tasks[task]);
            const nextTask = nextTaskIndex !== -1 ? TASKS[nextTaskIndex] : null;
            const status = nextTask ? `次: ${nextTask}` : '完了';
            const isOrderReceived = project.tasks['本社発注'];
            const isExpanded = expandedId === project.id;
            
            return (
            <div className="bg-white hover:bg-slate-50 transition-colors duration-200">
                <div className="flex justify-between items-start p-6 cursor-pointer" onClick={() => setExpandedId(isExpanded ? null : project.id)} role="button">
                    <div className="flex-grow pr-4" style={{ flexBasis: '40%' }}>
                        <div className="flex items-center gap-3">
                            {isOrderReceived && <span className="flex-shrink-0 text-xs font-bold text-red-700 bg-red-100 border border-red-300 rounded-md px-2 py-1">受注済</span>}
                            <h3 className="text-lg font-bold text-slate-900">{project.clientName} <span className="font-normal text-slate-500">/ {project.productType}</span></h3>
                        </div>
                        <span className={`inline-block text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full mt-2 ${nextTask ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>{status}</span>
                        <div className="text-sm text-slate-500 mt-4 flex flex-wrap gap-x-4 gap-y-1"><span>登録日: {new Date(project.registrationDate).toLocaleDateString('ja-JP')}</span><span>種別: {project.category}</span><span>金額: {project.mainAmount.toLocaleString()}円</span></div>
                    </div>
                    <div className="flex items-center space-x-2 pt-2" style={{ flexBasis: '60%' }}>
                        {TASKS.map((task, index) => {
                            const isCompleted = project.tasks[task];
                            const isCurrent = index === nextTaskIndex;
                            let taskElement;
                            if (isCompleted) {
                                taskElement = (<div className="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white" title={`${task} - 完了`}><CheckIcon className="w-4 h-4" /></div>);
                            } else if (isCurrent) {
                                taskElement = (<div className="w-6 h-6 rounded-full border-2 border-slate-800 bg-white" title={task}></div>);
                            } else {
                                taskElement = (<div className="w-6 h-6 rounded-full border-2 border-slate-300" title={task}></div>);
                            }
                            return (<div key={task} onClick={(e) => { e.stopPropagation(); onTaskToggle(project.id, task); }} className="flex-1 flex justify-center p-1" role="checkbox" aria-checked={isCompleted} aria-label={`Toggle task ${task}`}>{taskElement}</div>);
                        })}
                    </div>
                </div>
                <div className={`expandable-content ${isExpanded ? 'open' : ''}`}>
                    <ProjectDetailView project={project} onEdit={onEdit} onDelete={onDelete} onCarryOver={onCarryOver} />
                </div>
            </div>
            );
        };
        return (<div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden"><div className="flex justify-between items-center px-6 py-3 border-b text-xs font-semibold text-slate-500 sticky top-0 bg-white/70 backdrop-blur-sm rounded-t-2xl z-10"><div className="flex-grow" style={{ flexBasis: '40%' }}>案件情報</div><div className="flex items-center space-x-2" style={{ flexBasis: '60%' }}>{TASKS.map(task => <div key={task} className="flex-1 text-center">{task}</div>)}</div></div><div className="divide-y divide-slate-200">{projects.length === 0 ? (<div className="text-center py-10 text-slate-500">条件に合う案件はありません。</div>) : (projects.map(project => <ProjectCard key={project.id} project={project} onTaskToggle={onTaskToggle} onEdit={onEdit} onDelete={onDelete} onCarryOver={onCarryOver} />))}</div></div>);
      };
      
      const TargetAmountModal = ({ isOpen, onClose, currentAmount, onSave }) => {
        const [amount, setAmount] = useState(currentAmount);
        useEffect(() => { if(isOpen) setAmount(currentAmount) }, [isOpen, currentAmount]);
        if (!isOpen) return null;
        const handleSubmit = (e) => { e.preventDefault(); onSave(amount); onClose(); };
        return (<div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" onClick={onClose}><form onSubmit={handleSubmit} className="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform transition-all" onClick={e => e.stopPropagation()}><div className="p-6 border-b border-slate-200"><h3 className="text-xl font-bold text-slate-800">目標金額の登録</h3></div><div className="p-6"><Label htmlFor="targetAmount">目標金額 (税抜)</Label><input id="targetAmount" type="number" value={amount} onChange={(e) => setAmount(Number(e.target.value))} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" /></div><div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end items-center space-x-3"><button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">キャンセル</button><button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 transition">登録する</button></div></form></div>);
      };
      
      const FilterAndSort = ({ filters, onFilterChange }) => {
        const handleInputChange = (e) => { onFilterChange({ ...filters, [e.target.name]: e.target.value }); }
        return (<div className="p-5 border border-t-0 border-slate-200 rounded-b-lg bg-slate-50 space-y-4"><div><Label htmlFor="keyword">キーワード (顧客名, 案件名)</Label><Input type="text" id="keyword" name="keyword" value={filters.keyword} onChange={handleInputChange} /></div><div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"><div><Label htmlFor="status">ステータス</Label><Select id="status" name="status" value={filters.status} onChange={handleInputChange}>{STATUS_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</Select></div><div><Label htmlFor="category">顧客種別</Label><Select id="category" name="category" value={filters.category} onChange={handleInputChange}><option value="すべて">すべて</option>{CUSTOMER_CATEGORIES.map(c=><option key={c}>{c}</option>)}</Select></div><div><Label htmlFor="productType">商品種別</Label><Select id="productType" name="productType" value={filters.productType} onChange={handleInputChange}><option value="すべて">すべて</option>{PRODUCT_TYPES.map(o => <option key={o} value={o}>{o}</option>)}</Select></div><div><Label htmlFor="paymentType">支払区分</Label><Select id="paymentType" name="paymentType" value={filters.paymentType} onChange={handleInputChange}><option value="すべて">すべて</option>{PAYMENT_TYPES.map(o => <option key={o} value={o}>{o}</option>)}</Select></div></div><div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"><div><Label htmlFor="setup">セットアップ</Label><Select id="setup" name="setup" value={filters.setup} onChange={handleInputChange}><option value="すべて">すべて</option>{SETUP_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</Select></div><div><Label htmlFor="maintenance">保守契約</Label><Select id="maintenance" name="maintenance" value={filters.maintenance} onChange={handleInputChange}><option value="すべて">すべて</option>{MAINTENANCE_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</Select></div><div className="md:col-start-3"><Label htmlFor="sort">並び順</Label><Select id="sort" name="sort" value={filters.sort} onChange={handleInputChange}>{Object.entries(SORT_OPTIONS).map(([key, value]) => <option key={key} value={key}>{value}</option>)}</Select></div></div></div>);
      }
      
      const HeaderDashboard = ({ targetAmount, setTargetAmount, currentAmount, filters, setFilters, periods, selectedPeriod, setSelectedPeriod, remainingBusinessDays }) => {
        const [isFilterOpen, setIsFilterOpen] = useState(false);
        const [isTargetModalOpen, setIsTargetModalOpen] = useState(false);
        const progress = targetAmount > 0 ? Math.min((currentAmount / targetAmount) * 100, 100) : 0;
        return (<div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 space-y-4"><div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-end"><div><Label>対象期間</Label><Select value={selectedPeriod} onChange={(e) => setSelectedPeriod(e.target.value)}>{periods.map(p => <option key={p.value} value={p.value}>{p.label}</option>)}</Select></div><div className="flex flex-col"><Label>目標金額 (税抜)</Label><div className="flex items-center gap-2"><p className="flex-grow text-lg font-semibold text-slate-800 bg-slate-100 border border-slate-300 rounded-md p-2">{targetAmount.toLocaleString()}円</p><button onClick={() => setIsTargetModalOpen(true)} className="px-4 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">登録</button></div></div><div className="text-center"><p className="text-sm font-medium text-slate-600">期末までの残り営業日</p><p className="text-4xl font-bold text-blue-600">{remainingBusinessDays}<span className="text-lg font-medium ml-1">日</span></p></div></div><div className="pt-2"><div className="flex justify-between mb-1"><span className="text-sm font-medium text-slate-700">進捗 (本社発注済)</span><span className="text-sm font-medium text-slate-700">{currentAmount.toLocaleString()} / {targetAmount.toLocaleString()} 円</span></div><div className="w-full bg-slate-200 rounded-full h-2.5"><div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div></div></div><div><button onClick={() => setIsFilterOpen(!isFilterOpen)} className="w-full mt-4 flex justify-between items-center text-left p-3 bg-slate-50 hover:bg-slate-100 rounded-lg border border-slate-200"><span className="font-semibold text-slate-700">フィルター & 並び替え</span><ChevronUpIcon className={`w-5 h-5 text-slate-500 transition-transform ${isFilterOpen ? '' : 'rotate-180'}`} /></button><div className={`filter-content ${isFilterOpen ? 'open' : ''}`}><FilterAndSort filters={filters} onFilterChange={setFilters} /></div></div><TargetAmountModal isOpen={isTargetModalOpen} onClose={() => setIsTargetModalOpen(false)} currentAmount={targetAmount} onSave={setTargetAmount} /></div>);
      };
      
      const App = () => {
        const { periods, selectedPeriod, setSelectedPeriod, remainingBusinessDays } = usePeriodCalculator();
        
        const getInitialAppData = () => {
          try {
              const storedData = localStorage.getItem('orderManagementAppData');
              if (storedData) return JSON.parse(storedData);
          } catch (error) { console.error("Failed to parse app data from localStorage", error); }
          
          const initialProjects = [
            { id: 'proj-1', projectName: '事務所PCリプレイス', clientName: '川越税理士事務所', category: '会計事務所', registrationDate: '2025-10-14', mainAmount: 100000, division: 'リプレイス', productType: 'PC', paymentType: 'COD', setup: 'あり (SCG)', maintenance: 'あり', memo: 'なし', tasks: TASKS.reduce((acc, task, index) => ({ ...acc, [task]: index < 3 }), {})},
            { id: 'proj-2', projectName: '新規オフィスPC導入', clientName: '株式会社サンプル', category: '関与先', registrationDate: '2025-11-01', mainAmount: 3500000, division: '新規', productType: 'PC', paymentType: 'リース', setup: 'あり', maintenance: 'あり', memo: '', tasks: TASKS.reduce((acc, task, index) => ({ ...acc, [task]: index < 8 }), {})},
          ];

          return { [periods[0].value]: { projects: initialProjects, targetAmount: 10000000 } };
        };

        const [appData, setAppData] = useState(getInitialAppData);
        const [isNewProjectModalOpen, setIsNewProjectModalOpen] = useState(false);
        const [editingProject, setEditingProject] = useState(null);
        const [filters, setFilters] = useState({
            keyword: '', status: 'すべて', category: 'すべて', productType: 'すべて',
            paymentType: 'すべて', setup: 'すべて', maintenance: 'すべて', sort: 'registrationDate_asc'
        });

        useEffect(() => {
            try { localStorage.setItem('orderManagementAppData', JSON.stringify(appData)); } 
            catch (error) { console.error("Failed to save app data to localStorage", error); }
        }, [appData]);
        
        const currentPeriodData = useMemo(() => appData[selectedPeriod] || { projects: [], targetAmount: 0 }, [appData, selectedPeriod]);
        const projects = currentPeriodData.projects;
        const targetAmount = currentPeriodData.targetAmount;

        const setTargetAmountForPeriod = (newAmount) => {
            setAppData(prevData => ({ ...prevData, [selectedPeriod]: { ...currentPeriodData, targetAmount: newAmount } }));
        };

        const currentTotalAmount = useMemo(() => projects.reduce((sum, project) => project.tasks['本社発注'] ? sum + project.mainAmount : sum, 0), [projects]);

        const filteredAndSortedProjects = useMemo(() => {
          let filtered = [...projects];
          if (filters.keyword) { const lowerKeyword = filters.keyword.toLowerCase(); filtered = filtered.filter(p => p.clientName.toLowerCase().includes(lowerKeyword) || p.projectName.toLowerCase().includes(lowerKeyword)); }
          if (filters.status !== 'すべて') { filtered = filtered.filter(p => { const isComplete = TASKS.every(task => p.tasks[task]); return filters.status === '完了' ? isComplete : !isComplete; }); }
          ['category', 'productType', 'paymentType', 'setup', 'maintenance'].forEach(key => { if (filters[key] !== 'すべて') { filtered = filtered.filter(p => p[key] === filters[key]); } });
          const [key, order] = filters.sort.split('_');
          filtered.sort((a, b) => { if (key === 'registrationDate') { const dateA = new Date(a.registrationDate).getTime(); const dateB = new Date(b.registrationDate).getTime(); return order === 'asc' ? dateA - dateB : dateB - dateA; } return order === 'asc' ? a[key] - b[key] : b[key] - a[key]; });
          return filtered;
        }, [projects, filters]);

        const handleSaveProject = useCallback((projectData) => {
            setAppData(prevAppData => {
                const newAppData = { ...prevAppData };
                const periodData = newAppData[selectedPeriod] || { projects: [], targetAmount: 0 };
                let newProjects;
                if (editingProject) {
                    newProjects = periodData.projects.map(p => p.id === editingProject.id ? { ...projectData, tasks: p.tasks, id: p.id } : p);
                } else {
                    const newProject = { id: `proj-${Date.now()}`, tasks: TASKS.reduce((acc, task) => ({ ...acc, [task]: false }), {}), ...projectData };
                    newProjects = [newProject, ...periodData.projects];
                }
                newAppData[selectedPeriod] = { ...periodData, projects: newProjects };
                return newAppData;
            });
        }, [selectedPeriod, editingProject]);
        
        const handleOpenEditModal = (project) => { setEditingProject(project); setIsNewProjectModalOpen(true); };
        const handleCloseModal = () => { setIsNewProjectModalOpen(false); setEditingProject(null); };

        const handleTaskToggle = useCallback((projectId, clickedTask) => {
            setAppData(prevAppData => {
                const newAppData = { ...prevAppData };
                const periodData = newAppData[selectedPeriod];
                if (!periodData) return prevAppData;
                const newProjects = periodData.projects.map(p => {
                    if (p.id !== projectId) return p;
                    const newTasks = { ...p.tasks };
                    const taskIndex = TASKS.indexOf(clickedTask); const isChecking = !newTasks[clickedTask];
                    if (isChecking) { for (let i = 0; i <= taskIndex; i++) newTasks[TASKS[i]] = true; } 
                    else { for (let i = taskIndex; i < TASKS.length; i++) newTasks[TASKS[i]] = false; }
                    return { ...p, tasks: newTasks };
                });
                newAppData[selectedPeriod] = { ...periodData, projects: newProjects };
                return newAppData;
            });
        }, [selectedPeriod]);

        const handleDeleteProject = useCallback((projectId) => {
          if (window.confirm('この案件を削除してもよろしいですか？')) {
            setAppData(prevAppData => {
                const newAppData = { ...prevAppData };
                const periodData = newAppData[selectedPeriod];
                if (!periodData) return prevAppData;
                const newProjects = periodData.projects.filter(p => p.id !== projectId);
                newAppData[selectedPeriod] = { ...periodData, projects: newProjects };
                return newAppData;
            });
          }
        }, [selectedPeriod]);

        const handleCarryOverProject = useCallback((projectToCarryOver) => {
            const currentPeriodIndex = periods.findIndex(p => p.value === selectedPeriod);
            if (currentPeriodIndex === -1 || currentPeriodIndex === periods.length - 1) {
                alert('次の期間がないため、繰り越しできません。'); return;
            }
            if (window.confirm('この案件を次の期間に繰り越しますか？')) {
                const nextPeriod = periods[currentPeriodIndex + 1];
                const nextPeriodStartDate = new Date(periods[currentPeriodIndex].endDate);
                nextPeriodStartDate.setDate(nextPeriodStartDate.getDate() + 1);
                const carriedOverProject = { ...projectToCarryOver, registrationDate: nextPeriodStartDate.toISOString().split('T')[0] };
                setAppData(prevAppData => {
                    const newAppData = { ...prevAppData };
                    const currentPeriodData = newAppData[selectedPeriod];
                    newAppData[selectedPeriod] = { ...currentPeriodData, projects: currentPeriodData.projects.filter(p => p.id !== projectToCarryOver.id) };
                    const nextPeriodData = newAppData[nextPeriod.value] || { projects: [], targetAmount: 0 };
                    newAppData[nextPeriod.value] = { ...nextPeriodData, projects: [carriedOverProject, ...nextPeriodData.projects] };
                    return newAppData;
                });
                alert(`案件「${projectToCarryOver.projectName}」を${nextPeriod.label}に繰り越しました。`);
            }
        }, [selectedPeriod, periods]);

        return (
            <div className="min-h-screen p-4 sm:p-6 lg:p-8">
                <div className="max-w-7xl mx-auto space-y-8">
                    <header className="flex justify-between items-center flex-wrap gap-4">
                        <h1 className="text-3xl font-bold text-slate-900">受注・タスク管理ツール</h1>
                        <div className="flex items-center gap-2">
                           <button className="px-3 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">データインポート</button>
                           <button className="px-3 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">データエクスポート</button>
                           <button onClick={() => setIsNewProjectModalOpen(true)} className="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition"><PlusIcon className="w-5 h-5" />新規案件を登録</button>
                        </div>
                    </header>
                    <main className="space-y-8">
                        <HeaderDashboard targetAmount={targetAmount} setTargetAmount={setTargetAmountForPeriod} currentAmount={currentTotalAmount} filters={filters} setFilters={setFilters} periods={periods} selectedPeriod={selectedPeriod} setSelectedPeriod={setSelectedPeriod} remainingBusinessDays={remainingBusinessDays} />
                        <ProjectTable projects={filteredAndSortedProjects} onTaskToggle={handleTaskToggle} onEdit={handleOpenEditModal} onDelete={handleDeleteProject} onCarryOver={handleCarryOverProject} />
                    </main>
                </div>
                <NewProjectModal isOpen={isNewProjectModalOpen} onClose={handleCloseModal} onSaveProject={handleSaveProject} editingProject={editingProject} />
            </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>