<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>受発注管理ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* Simple transition for collapsible filter */
      .filter-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out;
      }
      .filter-content.open {
        max-height: 600px; /* Adjust as needed */
      }
      .goal-success-toast {
        animation: fadeInOut 3s ease-in-out;
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
      .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: white;
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useMemo, useCallback, useEffect, useRef } = React;

      // --- CONSTANTS ---
      const TASKS = [
        'ネゴ提案', '見積提示', '注文作成', '本社発注', '日程調整',
        '現地調整', '検収作成', '検収送付', '保守作成', '保守送付'
      ];
      const CUSTOMER_CATEGORIES = ['会計事務所', '関与先'];
      const DIVISIONS = ['新規', 'リプレイス', 'その他'];
      const PRODUCT_TYPES = ['PC', 'スキャナ', 'プリンタ', 'ルータ', 'その他'];
      const PAYMENT_TYPES = ['COD', 'MIST', '後払い'];
      const SETUP_OPTIONS = ['なし', 'あり (SCG)', 'あり (Q&A)', 'あり (NSG)'];
      const MAINTENANCE_OPTIONS = ['あり', 'なし'];
      const STATUS_OPTIONS = ['すべて', '受注済み', '完了済み', '失注'];
      const SORT_OPTIONS = {
        'registrationDate_desc': '登録日が新しい順',
        'registrationDate_asc': '登録日が古い順',
        'mainAmount_desc': '金額が高い順',
        'mainAmount_asc': '金額が低い順',
      };
      
      const JAPANESE_HOLIDAYS = new Set([
        // 2025
        '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-24', '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13', '2025-11-03', '2025-11-24',
        // 2026
        '2026-01-01', '2026-01-12', '2026-02-11', '2026-02-23', '2026-03-20', '2026-04-29', '2026-05-03', '2026-05-04', '2026-05-05', '2026-05-6', '2026-07-20', '2026-08-11', '2026-09-21', '2026-09-22', '2026-09-23', '2026-10-12', '2026-11-03', '2026-11-23',
      ]);

      // --- HELPERS ---
      const getVisibleTasks = (project) => {
          let visible = [...TASKS];
          if (project.division === '新規') {
              visible = visible.filter(t => t !== 'ネゴ提案');
          }
          if (project.paymentType === 'COD' && project.setup === 'なし') {
              visible = visible.filter(t => t !== '検収作成' && t !== '検収送付');
          }
          if (project.maintenance === 'なし') {
              visible = visible.filter(t => t !== '保守作成' && t !== '保守送付');
          }
          return visible;
      };

      const getProjectStatusCategory = (project) => {
        if (project.isLost) return 4; // 失注
        const visibleTasks = getVisibleTasks(project);
        const isCompleted = visibleTasks.every(task => project.tasks[task]);
        if (isCompleted) return 3; // 完了
        if (project.tasks['本社発注']) return 1; // 進行中 (受注)
        return 2; // 進行中 (未受注)
      };

      // --- ICONS ---
      const PlusIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>);
      const XIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>);
      const ChevronUpIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>);
      const EditIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>);
      const TrashIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.033-2.134H8.033C6.91 2.75 6 3.704 6 4.884v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>);
      const ArrowCircleRightIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>);
      const NoSymbolIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" /></svg>);
      const DocumentTextIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>);
      const CheckIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>);
      const RefreshIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.664 0l3.181-3.183m-3.181-4.991-3.181-3.183a8.25 8.25 0 0 0-11.664 0l-3.181 3.183" /></svg>);
      const ChatBubbleLeftEllipsisIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" /></svg>);

      // --- HOOKS ---
      const usePeriodCalculator = () => {
          const generatePeriods = () => {
              const periods = [];
              const startYear = 2025; // R7
              const startPeriod = 60;
              for (let i = 0; i < 5; i++) {
                  const year = startYear + i;
                  const period = startPeriod + i;
                  const reiwaYear = year - 2018;
                  periods.push({
                      label: `第${period}期 上期 (R${reiwaYear}年10月～R${reiwaYear + 1}年3月)`,
                      value: `${period}-1`,
                      startDate: new Date(year, 9, 1),
                      endDate: new Date(year + 1, 2, 31),
                  });
                  periods.push({
                      label: `第${period}期 下期 (R${reiwaYear + 1}年4月～R${reiwaYear + 1}年9月)`,
                      value: `${period}-2`,
                      startDate: new Date(year + 1, 3, 1),
                      endDate: new Date(year + 1, 8, 30),
                  });
              }
              return periods;
          };

          const allPeriods = useMemo(generatePeriods, []);
          
          const getCurrentPeriod = useCallback(() => {
              const now = new Date();
              return allPeriods.find(p => now >= p.startDate && now <= p.endDate) || allPeriods[0];
          }, [allPeriods]);

          const [selectedPeriod, setSelectedPeriod] = useState(getCurrentPeriod().value);
          
          return { periods: allPeriods, selectedPeriod, setSelectedPeriod, getCurrentPeriod };
      }

      // --- COMPONENTS ---
      const Input = (props) => <input {...props} className="block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const Select = (props) => <select {...props} className="block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const Label = ({htmlFor, children, className}) => <label htmlFor={htmlFor} className={`block text-sm font-medium text-slate-700 mb-1 ${className}`}>{children}</label>;
      
      const ModalInput = React.forwardRef((props, ref) => <input {...props} ref={ref} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />);
      const ModalSelect = (props) => <select {...props} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const ModalTextarea = (props) => <textarea {...props} rows="3" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const ModalLabel = ({htmlFor, children}) => <label htmlFor={htmlFor} className="block text-sm font-medium text-slate-700">{children}</label>;

      const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
          if (!isOpen) return null;
          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                      <div className="p-6">
                          <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                          <p className="mt-2 text-sm text-slate-600">{message}</p>
                      </div>
                      <div className="px-6 py-4 bg-slate-50 flex justify-end items-center space-x-3 rounded-b-lg">
                          <button onClick={onCancel} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition">キャンセル</button>
                          <button onClick={onConfirm} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">実行する</button>
                      </div>
                  </div>
              </div>
          );
      };

      const NewProjectModal = ({ isOpen, onClose, onSaveProject, editingProject }) => {
        const isEditMode = !!editingProject;
        const dateInputRef = useRef(null);

        const getInitialState = (project = null) => {
            if (project) return { setupAmount: 0, isLost: false, ...project };
            return {
                category: CUSTOMER_CATEGORIES[0], clientName: '', registrationDate: new Date().toISOString().split('T')[0],
                mainAmount: 0, projectName: '', division: DIVISIONS[0], productType: PRODUCT_TYPES[0],
                paymentType: PAYMENT_TYPES[0], setup: SETUP_OPTIONS[0], maintenance: MAINTENANCE_OPTIONS[0], memo: '', setupAmount: 0, isLost: false,
            };
        };
        
        const [formState, setFormState] = useState(getInitialState(editingProject));
        const [step, setStep] = useState(1);

        const availableProductTypes = useMemo(() => {
            if (formState.category === '関与先') return PRODUCT_TYPES.filter(p => p !== 'ルータ');
            return PRODUCT_TYPES;
        }, [formState.category]);

        const availablePaymentTypes = useMemo(() => {
            if (formState.category === '関与先') return PAYMENT_TYPES.filter(p => p !== 'MIST');
            return PAYMENT_TYPES;
        }, [formState.category]);

        const availableSetupOptions = useMemo(() => {
            if (formState.category === '会計事務所') return SETUP_OPTIONS.filter(s => s !== 'あり (Q&A)');
            if (formState.category === '関与先') return SETUP_OPTIONS.filter(s => s !== 'あり (NSG)');
            return SETUP_OPTIONS;
        }, [formState.category]);
        
        useEffect(() => { 
            if (isOpen) {
                const initialState = getInitialState(editingProject);
                setFormState(initialState);
                setStep(isEditMode ? 2 : 1);
            }
        }, [isOpen, editingProject]);
        
        useEffect(() => {
          if (isOpen && step === 2) {
            setTimeout(() => dateInputRef.current?.focus(), 100);
          }
        }, [isOpen, step]);
        
        useEffect(() => {
            const updates = {};
            if (!availableProductTypes.includes(formState.productType)) {
                updates.productType = availableProductTypes[0];
            }
            if (!availablePaymentTypes.includes(formState.paymentType)) {
                updates.paymentType = availablePaymentTypes[0];
            }
            if (!availableSetupOptions.includes(formState.setup)) {
                updates.setup = availableSetupOptions[0];
            }
            if (Object.keys(updates).length > 0) {
                setFormState(prev => ({ ...prev, ...updates }));
            }
        }, [formState.category, availableProductTypes, availablePaymentTypes, availableSetupOptions]);

        const handleCategorySelect = (category) => {
            setFormState(prev => ({...getInitialState(), category}));
            setStep(2);
        };

        const handleAmountChange = (e) => {
            const { name, value } = e.target;
            const sanitizedValue = value.replace(/,/g, '');
            if (/^\d*$/.test(sanitizedValue)) {
                const numValue = sanitizedValue === '' ? 0 : parseInt(sanitizedValue, 10);
                setFormState(prev => ({ ...prev, [name]: numValue }));
            }
        };

        const handleChange = (e) => {
            const { name, value, type } = e.target;
            setFormState(prevFormState => {
                const newFormState = { ...prevFormState, [name]: value };

                if (name === 'productType') {
                    if (value === 'PC' || value === 'プリンタ') {
                        newFormState.paymentType = 'COD'; newFormState.maintenance = 'あり';
                    } else if (value === 'スキャナ') {
                        newFormState.paymentType = 'COD'; newFormState.setup = 'なし'; newFormState.maintenance = 'なし'; newFormState.setupAmount = 0;
                    } else if (value === 'ルータ' && prevFormState.category === '会計事務所') {
                        newFormState.paymentType = 'MIST'; newFormState.setup = 'あり (NSG)'; newFormState.setupAmount = 30000;
                    }
                } else if (name === 'setup') {
                    if (prevFormState.category === '関与先' && value === 'あり (SCG)') {
                        newFormState.setupAmount = 20000;
                    } else if (value === 'あり (Q&A)') {
                        newFormState.setupAmount = 15000;
                    } else if (value === 'あり (NSG)') {
                        newFormState.setupAmount = 30000;
                    } else if (value === 'なし') {
                        newFormState.setupAmount = 0;
                    }
                }
                return newFormState;
            });
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!formState.registrationDate || !formState.projectName || !formState.clientName) { alert('登録日、顧客名、案件名は必須です。'); return; }
            onSaveProject(formState); 
            onClose();
        };

        if (!isOpen) return null;
        
        const showSetupAmount = formState.setup !== 'なし';

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" onClick={onClose}>
                {step === 1 && !isEditMode && (
                     <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all p-8 text-center" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-slate-800 mb-2">新規案件の登録</h3>
                        <p className="text-slate-600 mb-8">まず、顧客種別を選択してください</p>
                        <div className="flex justify-center gap-4">
                            <button onClick={() => handleCategorySelect(CUSTOMER_CATEGORIES[0])} className="w-40 h-16 text-lg font-semibold text-blue-600 bg-blue-50 border-2 border-blue-500 rounded-lg hover:bg-blue-100 transition-colors">{CUSTOMER_CATEGORIES[0]}</button>
                            <button onClick={() => handleCategorySelect(CUSTOMER_CATEGORIES[1])} className="w-40 h-16 text-lg font-semibold text-blue-600 bg-blue-50 border-2 border-blue-500 rounded-lg hover:bg-blue-100 transition-colors">{CUSTOMER_CATEGORIES[1]}</button>
                        </div>
                    </div>
                )}
                {step === 2 && (
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-slate-200 flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800">{isEditMode ? '案件の編集' : `新規案件の登録 (${formState.category})`}</h3><button onClick={onClose} className="p-1 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><XIcon className="w-5 h-5" /></button></div>
                        <form onSubmit={handleSubmit}>
                            <div className="p-6 max-h-[70vh] overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <div><ModalLabel htmlFor="registrationDate">登録日 <span className="text-red-500">*</span></ModalLabel><ModalInput type="date" name="registrationDate" id="registrationDate" value={formState.registrationDate} onChange={handleChange} ref={dateInputRef} required /></div>
                                <div><ModalLabel htmlFor="clientName">顧客名 <span className="text-red-500">*</span></ModalLabel><ModalInput type="text" name="clientName" id="clientName" value={formState.clientName} onChange={handleChange} required /></div>
                                <div className="md:col-span-2"><ModalLabel htmlFor="projectName">案件名 <span className="text-red-500">*</span></ModalLabel><ModalInput type="text" name="projectName" id="projectName" value={formState.projectName} onChange={handleChange} required /></div>
                                <div><ModalLabel htmlFor="mainAmount">本体金額 (税抜)</ModalLabel><ModalInput type="text" name="mainAmount" id="mainAmount" value={formState.mainAmount.toLocaleString()} onChange={handleAmountChange} /></div>
                                <div><ModalLabel htmlFor="division">区分</ModalLabel><ModalSelect name="division" id="division" value={formState.division} onChange={handleChange}>{DIVISIONS.map(d => <option key={d}>{d}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="productType">商品種別</ModalLabel><ModalSelect name="productType" id="productType" value={formState.productType} onChange={handleChange}>{availableProductTypes.map(p => <option key={p}>{p}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="paymentType">支払区分</ModalLabel><ModalSelect name="paymentType" id="paymentType" value={formState.paymentType} onChange={handleChange}>{availablePaymentTypes.map(p => <option key={p}>{p}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="setup">セットアップ</ModalLabel><ModalSelect name="setup" id="setup" value={formState.setup} onChange={handleChange}>{availableSetupOptions.map(s => <option key={s}>{s}</option>)}</ModalSelect></div>
                                {showSetupAmount && <div><ModalLabel htmlFor="setupAmount">セットアップ金額 (税抜)</ModalLabel><ModalInput type="text" name="setupAmount" id="setupAmount" value={formState.setupAmount.toLocaleString()} onChange={handleAmountChange} readOnly={formState.setup !== 'あり (SCG)'} /></div>}
                                <div><ModalLabel htmlFor="maintenance">保守契約</ModalLabel><ModalSelect name="maintenance" id="maintenance" value={formState.maintenance} onChange={handleChange}>{MAINTENANCE_OPTIONS.map(m => <option key={m}>{m}</option>)}</ModalSelect></div>
                                <div className="md:col-span-2"><ModalLabel htmlFor="memo">メモ</ModalLabel><ModalTextarea name="memo" id="memo" value={formState.memo} onChange={handleChange} /></div>
                            </div>
                            <div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end items-center space-x-3"><button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">キャンセル</button><button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 transition">{isEditMode ? '更新する' : '登録する'}</button></div>
                        </form>
                    </div>
                )}
            </div>
        );
      };

      const DetailItem = ({ label, value, className = "" }) => (<div className={`flex flex-col ${className}`}><dt className="text-xs text-slate-500">{label}</dt><dd className="text-sm text-slate-900 mt-1 break-words">{value || 'ー'}</dd></div>);

      const ProjectDetailModal = ({ isOpen, project, onClose, onEdit, onDelete, onCarryOver, onSetLost, onUndoLost }) => {
        if (!isOpen || !project) return null;

        const setupAmount = project.setupAmount || 0;
        const totalAmount = project.mainAmount + setupAmount;

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all" onClick={e => e.stopPropagation()}>
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="text-xl font-bold text-slate-800">案件詳細</h3>
                        <button onClick={onClose} className="p-1 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><XIcon className="w-5 h-5" /></button>
                    </div>
                    <div className="p-6 max-h-[70vh] overflow-y-auto">
                        <div className="mb-6 pb-6 border-b border-slate-200">
                             <p className="text-xs text-slate-500">顧客名</p>
                             <h4 className="text-2xl font-bold text-slate-900">{project.clientName}</h4>
                             <p className="text-xs text-slate-500 mt-4">案件名</p>
                             <p className="text-lg text-slate-700 mt-1">{project.projectName}</p>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-y-6 gap-x-4">
                            <DetailItem label="顧客種別" value={project.category} />
                            <DetailItem label="区分" value={project.division} />
                            <DetailItem label="商品種別" value={project.productType} />
                            <DetailItem label="支払区分" value={project.paymentType} />
                            <DetailItem label="セットアップ" value={project.setup} />
                            <DetailItem label="保守契約" value={project.maintenance} />
                            <DetailItem label="登録日" value={new Date(project.registrationDate).toLocaleDateString('ja-JP')} />
                            <div className="flex flex-col">
                               <dt className="text-xs text-slate-500">金額内訳</dt>
                               <dd className="text-sm text-slate-900 mt-1">
                                    <div>本体: {project.mainAmount.toLocaleString()}円</div>
                                    <div>セットアップ: {setupAmount.toLocaleString()}円</div>
                                    <div className="font-bold border-t border-slate-200 mt-1 pt-1">合計: {totalAmount.toLocaleString()}円</div>
                               </dd>
                            </div>
                            <DetailItem label="メモ" value={project.memo} className="col-span-2 md:col-span-3" />
                        </div>
                    </div>
                     <div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex items-center gap-4 text-slate-600">
                        <button onClick={() => { onEdit(project); onClose(); }} className="flex items-center gap-2 hover:text-blue-600"><EditIcon className="w-5 h-5" /><span>編集</span></button>
                        {project.isLost ? (
                            <button onClick={() => onUndoLost(project.id)} className="flex items-center gap-2 hover:text-green-600"><RefreshIcon className="w-5 h-5" /><span>失注を取り消す</span></button>
                        ) : (
                            <button onClick={() => onSetLost(project.id)} className="flex items-center gap-2 hover:text-orange-600"><NoSymbolIcon className="w-5 h-5" /><span>失注</span></button>
                        )}
                        <button onClick={() => onDelete(project.id)} className="flex items-center gap-2 hover:text-red-600"><TrashIcon className="w-5 h-5" /><span>削除</span></button>
                        <button onClick={() => onCarryOver(project)} className="flex items-center gap-2 hover:text-green-600"><ArrowCircleRightIcon className="w-5 h-5" /><span>繰り越し</span></button>
                        <div className="flex-grow"></div>
                        <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">閉じる</button>
                    </div>
                </div>
            </div>
        );
      };

      const MemoModal = ({ isOpen, project, onClose, onSave }) => {
          const [memo, setMemo] = useState('');

          useEffect(() => {
              if (project) {
                  setMemo(project.memo || '');
              }
          }, [project]);

          if (!isOpen || !project) return null;

          const handleSave = () => {
              onSave(project, memo);
              onClose();
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                      <div className="p-6">
                          <h3 className="text-lg font-bold text-slate-800">{project.clientName} - メモ</h3>
                          <p className="text-sm text-slate-500 mt-1 truncate">{project.projectName}</p>
                          <ModalTextarea value={memo} onChange={e => setMemo(e.target.value)} className="mt-4" rows="5" />
                      </div>
                      <div className="px-6 py-4 bg-slate-50 flex justify-end items-center space-x-3 rounded-b-lg">
                          <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition">キャンセル</button>
                          <button onClick={handleSave} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">保存する</button>
                      </div>
                  </div>
              </div>
          );
      };

      const TaskStatus = ({ status, onClick, disabled }) => {
          const baseClasses = "w-6 h-6 rounded-full flex items-center justify-center transition-all duration-300 ease-in-out";
          const interactiveClasses = disabled ? 'cursor-not-allowed opacity-60' : 'cursor-pointer transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400';

          switch (status) {
              case 'completed':
                  return (
                      <button onClick={onClick} disabled={disabled} title="完了" className={`${baseClasses} ${interactiveClasses} bg-blue-500 shadow`}>
                          <CheckIcon className="w-4 h-4 text-white" />
                      </button>
                  );
              case 'next':
                  return (
                      <button onClick={onClick} disabled={disabled} title="次のタスク" className={`${baseClasses} ${interactiveClasses} bg-blue-200 border border-blue-400 shadow`}></button>
                  );
              case 'pending':
                  return (
                      <button onClick={onClick} disabled={disabled} title="未完了" className={`${baseClasses} ${interactiveClasses} bg-slate-200 hover:bg-slate-300`}></button>
                  );
              case 'skipped':
                   return (
                      <div title="対象外" className={`${baseClasses}`}></div>
                  );
              default:
                  return <div className={baseClasses}></div>;
          }
      };
      
      const HankoStamp = ({ status }) => {
        if (!status) return <div className="w-10 h-10 flex-shrink-0"></div>;

        const styles = {
            '受注': 'text-red-600 border-red-600',
            '完了': 'text-blue-600 border-blue-600',
            '失注': 'text-slate-500 border-slate-500',
        };
        
        return (
            <div className={`flex-shrink-0 flex items-center justify-center w-10 h-10 border-2 rounded-full font-serif font-bold text-sm transform -rotate-12 ${styles[status]}`}>
                {status}
            </div>
        );
      };

      const ProjectCard = ({ project, onViewDetails, onTaskToggle, onOpenMemo }) => {
          const totalAmount = project.mainAmount + (project.setupAmount || 0);
          
          const visibleTasks = useMemo(() => getVisibleTasks(project), [project]);
          const completedVisibleTasks = visibleTasks.filter(task => project.tasks[task]);
          
          const isLost = project.isLost;
          const isCompleted = !isLost && completedVisibleTasks.length === visibleTasks.length;
          const isOrdered = !isLost && !isCompleted && project.tasks['本社発注'];
          const nextVisibleTask = !isLost && !isCompleted ? visibleTasks.find(task => !project.tasks[task]) : null;

          let status = null;
          if (isLost) status = '失注';
          else if (isCompleted) status = '完了';
          else if (isOrdered) status = '受注';

          return (
            <tr className={`hover:bg-slate-50 transition-colors duration-200 ${project.isLost ? 'opacity-60 grayscale' : ''}`}>
                <td className="p-2 pl-4">
                  <div className="flex items-center gap-3 min-w-0">
                      <HankoStamp status={status} />
                      <div className="flex-grow min-w-0">
                          <h3 className="font-bold text-slate-900 truncate text-base">{project.clientName}</h3>
                          <p className="text-slate-500 text-xs mt-1 truncate">{project.projectName}</p>
                      </div>
                  </div>
                </td>
                <td className="p-2 text-slate-600 text-center">{new Date(project.registrationDate).toLocaleDateString('ja-JP')}</td>
                 <td className="p-2 text-center">
                    <button onClick={() => onOpenMemo(project)} className={`p-2 rounded-full transition-colors ${project.memo ? 'text-blue-600 bg-blue-100 hover:bg-blue-200' : 'text-slate-400 hover:bg-slate-200 hover:text-slate-600'}`} title="メモ">
                        <ChatBubbleLeftEllipsisIcon className="w-5 h-5" />
                    </button>
                </td>
                <td className="p-2 font-semibold text-slate-800 text-right">{totalAmount.toLocaleString()}円</td>
                {TASKS.map((task) => {
                    const isVisible = visibleTasks.includes(task);
                    const isCompleted = project.tasks[task];
                    const isNext = task === nextVisibleTask;
                    
                    let taskStatus = 'pending';
                    if (!isVisible) taskStatus = 'skipped';
                    else if (isCompleted) taskStatus = 'completed';
                    else if (isNext) taskStatus = 'next';
                    
                    const isDisabled = project.isLost;

                    return (
                        <td key={task} className="text-center">
                            <div className="flex justify-center items-center h-full">
                                <TaskStatus
                                    status={taskStatus}
                                    onClick={() => onTaskToggle(project.id, task)}
                                    disabled={isDisabled}
                                />
                            </div>
                        </td>
                    );
                })}
                <td className="p-2 text-center">
                    <button onClick={() => onViewDetails(project)} className="p-2 text-slate-500 hover:bg-slate-200 hover:text-slate-800 rounded-full transition-colors" title="詳細を表示">
                        <DocumentTextIcon className="w-5 h-5" />
                    </button>
                </td>
            </tr>
          );
      };

      const ProjectTable = ({ projects, onViewDetails, onTaskToggle, onOpenMemo }) => {
        return (
            <div className="bg-white shadow-lg rounded-xl overflow-x-auto mt-6" style={{maxHeight: '70vh'}}>
                <table className="w-full min-w-[1220px] border-collapse text-sm">
                    <thead className="sticky-header">
                        <tr className="border-b-2 border-slate-300 text-xs font-semibold text-slate-600">
                            <th className="p-2 pl-4 text-left w-[25%]">顧客・案件名</th>
                            <th className="p-2 text-center w-[8%]">登録日</th>
                            <th className="p-2 text-center w-[5%]">メモ</th>
                            <th className="p-2 text-right w-[10%]">金額 (総額)</th>
                            {TASKS.map(task => (
                                <th key={task} className="p-1 text-center text-[10px] leading-tight break-words w-[4%]">{task}</th>
                            ))}
                            <th className="p-2 text-center w-[5%]">詳細</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-200">
                        {projects.length > 0 ? (
                            projects.map(project => <ProjectCard key={project.id} {...{ project, onViewDetails, onTaskToggle, onOpenMemo }} />)
                        ) : (
                             <tr>
                                 <td colSpan={TASKS.length + 5} className="p-12 text-center text-slate-500">
                                    <h3 className="text-lg font-semibold">案件がありません</h3>
                                    <p className="mt-2 text-sm">右上の「新規案件」ボタンから新しい案件を登録してください。</p>
                                 </td>
                             </tr>
                        )}
                    </tbody>
                </table>
            </div>
        );
      };

      const DashboardCard = ({ title, value, subtext, colorClass = "text-slate-900" }) => (
          <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm h-full flex flex-col">
              <div className="text-sm text-slate-500">{title}</div>
              <div className={`text-3xl font-bold mt-1 ${colorClass}`}>{value}</div>
              {subtext && <div className="text-xs text-slate-400 mt-1">{subtext}</div>}
          </div>
      );

      const AchievementStamp = () => (
          <div className="absolute -top-3 -right-3 z-10">
              <div className="flex items-center justify-center w-20 h-20 border-4 border-red-500 bg-white/70 backdrop-blur-sm rounded-full font-serif font-bold text-red-500 transform rotate-12">
                  <span className="text-3xl">達成</span>
              </div>
          </div>
      );

      const ProgressBar = ({ percentage }) => {
        const cappedPercentage = Math.min(percentage, 100);
        const colorClasses = [
            'bg-red-500',    // 0-9%
            'bg-orange-500', // 10-19%
            'bg-amber-500',  // 20-29%
            'bg-yellow-500', // 30-39%
            'bg-lime-500',   // 40-49%
            'bg-green-500',  // 50-59%
            'bg-emerald-500',// 60-69%
            'bg-teal-500',   // 70-79%
            'bg-cyan-500',   // 80-89%
            'bg-sky-500',    // 90-99%
            'bg-blue-600',   // 100%
        ];
        const colorIndex = Math.floor(cappedPercentage / 10);
        const colorClass = colorClasses[Math.min(colorIndex, colorClasses.length - 1)];

        return (
            <div className="w-full bg-slate-200 rounded-full h-4">
                <div
                    className={`h-4 rounded-full transition-all duration-500 ease-out ${colorClass}`}
                    style={{ width: `${cappedPercentage}%` }}
                ></div>
            </div>
        );
      };

      const Dashboard = ({ projects, goalAmount, setGoalAmount }) => {
          const [isEditingGoal, setIsEditingGoal] = useState(false);
          const [tempGoal, setTempGoal] = useState(goalAmount);
          const [showSuccess, setShowSuccess] = useState(false);

          const stats = useMemo(() => {
              const allNonLostProjects = projects.filter(p => !p.isLost);
              const totalAmount = allNonLostProjects.reduce((sum, p) => sum + p.mainAmount + (p.setupAmount || 0), 0);
              const orderedProjects = allNonLostProjects.filter(p => p.tasks['本社発注']);
              const orderedAmount = orderedProjects.reduce((sum, p) => sum + p.mainAmount + (p.setupAmount || 0), 0);
              const achievementRate = goalAmount > 0 ? (orderedAmount / goalAmount) * 100 : 0;
              return { totalAmount, orderedAmount, achievementRate, orderedProjectsCount: orderedProjects.length, totalProjectsCount: allNonLostProjects.length };
          }, [projects, goalAmount]);
          
          const handleSaveGoal = () => {
              const newGoal = Number(tempGoal) || 0;
              setGoalAmount(newGoal);
              setIsEditingGoal(false);
              setShowSuccess(true);
              setTimeout(() => setShowSuccess(false), 3000);
          }
          
          useEffect(() => {
              setTempGoal(goalAmount);
          }, [goalAmount]);

          return (
            <div className="bg-slate-50/50 shadow-lg rounded-xl p-6 mb-6">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <DashboardCard title="対象総額" value={`${stats.totalAmount.toLocaleString()}円`} subtext={`${stats.totalProjectsCount}件`} />
                     <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm relative h-full">
                        {showSuccess && <div className="absolute top-2 right-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded goal-success-toast">目標金額を登録しました！</div>}
                        <div className="text-sm text-slate-500">目標金額</div>
                        {isEditingGoal ? (
                          <div className="mt-1">
                            <input type="number" value={tempGoal} onChange={e => setTempGoal(e.target.value)} className="block w-full px-2 py-1 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            <div className="flex gap-2 mt-2">
                              <button onClick={handleSaveGoal} className="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">保存</button>
                              <button onClick={() => { setIsEditingGoal(false); setTempGoal(goalAmount); }} className="px-3 py-1 text-xs font-medium text-slate-700 bg-slate-100 border border-slate-300 rounded-md hover:bg-slate-200">キャンセル</button>
                            </div>
                          </div>
                        ) : (
                          <div className="flex justify-between items-end">
                            <div className="text-3xl font-bold mt-1 text-slate-900">{goalAmount.toLocaleString()}<span className="text-lg ml-1">円</span></div>
                            <button onClick={() => setIsEditingGoal(true)} className="px-3 py-1 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100">登録</button>
                          </div>
                        )}
                    </div>
                    <DashboardCard title="受注金額" value={`${stats.orderedAmount.toLocaleString()}円`} colorClass="text-blue-600" subtext={`${stats.orderedProjectsCount}件`} />
                    <div className="relative h-full">
                        <DashboardCard title="目標達成率" value={`${stats.achievementRate.toFixed(1)}%`} colorClass="text-blue-600" />
                        {stats.achievementRate >= 100 && <AchievementStamp />}
                    </div>
                </div>
                <div className="mt-6">
                    <div className="flex justify-end items-baseline text-sm font-medium text-slate-600 mb-1">
                        <span>{stats.orderedAmount.toLocaleString()}円</span>
                        <span className="text-slate-400 mx-1">/</span>
                        <span>{goalAmount.toLocaleString()}円</span>
                    </div>
                    <ProgressBar percentage={stats.achievementRate} />
                </div>
            </div>
          );
      };

      const App = () => {
          const periodData = usePeriodCalculator();
          const { selectedPeriod, setSelectedPeriod, getCurrentPeriod, periods } = periodData;

          const [allData, setAllData] = useState(() => {
              try {
                  const savedData = localStorage.getItem('allPeriodData');
                  return savedData ? JSON.parse(savedData) : {};
              } catch (error) {
                  console.error("Error loading all data from localStorage", error); return {};
              }
          });

          // One-time migration from old data structure
          useEffect(() => {
            const oldProjectsJSON = localStorage.getItem('projects');
            if (oldProjectsJSON) {
              try {
                const oldGoalJSON = localStorage.getItem('goalAmount');
                const currentPeriodValue = getCurrentPeriod().value;
                
                setAllData(prevData => {
                  const migratedData = {
                      projects: JSON.parse(oldProjectsJSON),
                      goalAmount: oldGoalJSON ? Number(JSON.parse(oldGoalJSON)) : 10000000
                  };
                  // Avoid overwriting if new data for the period already exists
                  if (!prevData[currentPeriodValue]) {
                      return { ...prevData, [currentPeriodValue]: migratedData };
                  }
                  return prevData;
                });

                localStorage.removeItem('projects');
                localStorage.removeItem('goalAmount');
              } catch (error) {
                console.error("Failed to migrate data", error);
              }
            }
          }, [getCurrentPeriod]);

          useEffect(() => {
              try {
                  localStorage.setItem('allPeriodData', JSON.stringify(allData));
              } catch (error) { console.error("Error saving all data to localStorage", error); }
          }, [allData]);

          const { projects, goalAmount } = useMemo(() => {
              return allData[selectedPeriod] || { projects: [], goalAmount: 10000000 };
          }, [allData, selectedPeriod]);

          const setProjectsForCurrentPeriod = (update) => {
              setAllData(prevAllData => {
                  const currentData = prevAllData[selectedPeriod] || { projects: [], goalAmount: 10000000 };
                  const newProjects = typeof update === 'function' ? update(currentData.projects) : update;
                  return {
                      ...prevAllData,
                      [selectedPeriod]: { ...currentData, projects: newProjects },
                  };
              });
          };

          const setGoalAmountForCurrentPeriod = (newGoal) => {
              setAllData(prevAllData => {
                  const currentData = prevAllData[selectedPeriod] || { projects: [], goalAmount: 10000000 };
                  return {
                      ...prevAllData,
                      [selectedPeriod]: { ...currentData, goalAmount: newGoal },
                  };
              });
          };

          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingProject, setEditingProject] = useState(null);
          const [viewingProject, setViewingProject] = useState(null);
          const [memoModalProject, setMemoModalProject] = useState(null);
          const initialFilters = { keyword: '', status: 'すべて', customerCategory: 'すべて' };
          const [filters, setFilters] = useState(initialFilters);
          const [sortKey, setSortKey] = useState('registrationDate_asc');
          const [isFilterVisible, setIsFilterVisible] = useState(false);
          const [confirmation, setConfirmation] = useState({ isOpen: false, title: '', message: '', onConfirm: null, onCancel: null });
          
          const handleSaveProject = (projectData) => {
              setProjectsForCurrentPeriod(prevProjects => {
                  if (projectData.id) { // Update existing
                      return prevProjects.map(p => p.id === projectData.id ? { ...p, ...projectData } : p);
                  } else { // Add new
                      const newProject = { 
                          ...projectData, 
                          id: Date.now(), 
                          tasks: TASKS.reduce((acc, task) => ({...acc, [task]: false}), {}) 
                      };
                      return [...prevProjects, newProject];
                  }
              });
              setEditingProject(null);
          };

          const handleEditProject = (project) => {
              setEditingProject(project);
              setIsModalOpen(true);
          };

          const handleDeleteProject = (projectId) => {
              setConfirmation({
                  isOpen: true, title: '案件の削除', message: 'この案件を完全に削除します。この操作は元に戻せません。よろしいですか？',
                  onConfirm: () => {
                      setProjectsForCurrentPeriod(prev => prev.filter(p => p.id !== projectId));
                      setViewingProject(null);
                      setConfirmation({ isOpen: false });
                  },
                  onCancel: () => setConfirmation({ isOpen: false })
              });
          };
          
          const handleSetLost = (projectId) => {
              setConfirmation({
                  isOpen: true, title: '失注の確認', message: 'この案件を「失注」としてマークしますか？タスクの変更ができなくなります。',
                  onConfirm: () => {
                      setProjectsForCurrentPeriod(prev => prev.map(p => p.id === projectId ? {...p, isLost: true} : p));
                      setViewingProject(prev => prev && prev.id === projectId ? {...prev, isLost: true} : prev);
                      setConfirmation({ isOpen: false });
                  },
                  onCancel: () => setConfirmation({ isOpen: false })
              });
          };

          const handleUndoLost = (projectId) => {
              setConfirmation({
                  isOpen: true, title: '失注の取り消し', message: 'この案件を「失注」から戻しますか？タスクの変更が可能になります。',
                  onConfirm: () => {
                      setProjectsForCurrentPeriod(prev => prev.map(p => p.id === projectId ? {...p, isLost: false} : p));
                      setViewingProject(null);
                      setConfirmation({ isOpen: false });
                  },
                  onCancel: () => setConfirmation({ isOpen: false })
              });
          };

          const handleTaskToggle = (projectId, taskName) => {
              setProjectsForCurrentPeriod(prevProjects => prevProjects.map(p => {
                  if (p.id === projectId && !p.isLost) {
                      const newTasks = { ...p.tasks, [taskName]: !p.tasks[taskName] };
                      return { ...p, tasks: newTasks };
                  }
                  return p;
              }));
          };

          const handleCarryOver = (project) => {
              setConfirmation({
                isOpen: true, title: '案件の繰越', message: `${project.clientName}の案件をコピーして繰り越しますか？`,
                onConfirm: () => {
                    const newProject = {
                        ...project, id: Date.now(), registrationDate: new Date().toISOString().split('T')[0],
                        tasks: TASKS.reduce((acc, task) => ({...acc, [task]: false}), {}),
                        isLost: false, memo: `(繰越元: ${project.registrationDate} ${project.projectName})\n${project.memo}`
                    };
                    setProjectsForCurrentPeriod(prev => [...prev, newProject]);
                    setConfirmation({isOpen: false});
                    setViewingProject(null);
                },
                onCancel: () => setConfirmation({isOpen: false})
              });
          };

          const handleSaveMemo = (project, newMemo) => {
            handleSaveProject({ ...project, memo: newMemo });
          };

          const handleFilterChange = (e) => {
              setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
          };

          const handleResetFilters = () => {
              setFilters(initialFilters);
              setSortKey('registrationDate_asc');
          };

          const filteredAndSortedProjects = useMemo(() => {
              let result = projects.filter(p => {
                    const keywordMatch = filters.keyword === '' || 
                        p.clientName.toLowerCase().includes(filters.keyword.toLowerCase()) || 
                        p.projectName.toLowerCase().includes(filters.keyword.toLowerCase());

                    const visibleTasks = getVisibleTasks(p);
                    const isCompleted = visibleTasks.every(task => p.tasks[task]);

                    const statusMatch = filters.status === 'すべて' ? true :
                        filters.status === '受注済み' ? p.tasks['本社発注'] && !isCompleted && !p.isLost :
                        filters.status === '完了済み' ? isCompleted && !p.isLost :
                        filters.status === '失注' ? p.isLost : false;
                    
                    const categoryMatch = filters.customerCategory === 'すべて' || p.category === filters.customerCategory;
                    
                    return keywordMatch && statusMatch && categoryMatch;
              });

              result.sort((a, b) => {
                  const categoryA = getProjectStatusCategory(a);
                  const categoryB = getProjectStatusCategory(b);

                  if (categoryA !== categoryB) {
                      return categoryA - categoryB;
                  }
                  
                  const [key, order] = sortKey.split('_');
                  const valA = key === 'mainAmount' ? a.mainAmount + (a.setupAmount || 0) : a[key];
                  const valB = key === 'mainAmount' ? b.mainAmount + (b.setupAmount || 0) : b[key];
                  if (valA < valB) return order === 'asc' ? -1 : 1;
                  if (valA > valB) return order === 'asc' ? 1 : -1;
                  return 0;
              });
              return result;
          }, [projects, filters, sortKey]);

          return (
              <div className="container mx-auto p-4 md:p-8 max-w-full">
                  <header className="flex flex-wrap items-center justify-between gap-y-4 mb-6">
                      <h1 className="text-3xl font-bold text-slate-900">受発注管理ツール</h1>
                      <div className="flex items-center gap-4">
                        <div>
                            <Label htmlFor="periodSelect" className="sr-only">対象期間</Label>
                            <Select id="periodSelect" value={selectedPeriod} onChange={e => setSelectedPeriod(e.target.value)}>
                                {periods.map(p => <option key={p.value} value={p.value}>{p.label}</option>)}
                            </Select>
                        </div>
                        <button onClick={() => { setEditingProject(null); setIsModalOpen(true); }} className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                            <PlusIcon className="w-5 h-5" />
                            <span>新規案件</span>
                        </button>
                      </div>
                  </header>
                  
                  <Dashboard 
                    projects={projects} 
                    goalAmount={goalAmount} 
                    setGoalAmount={setGoalAmountForCurrentPeriod} 
                  />

                  <div className="bg-white shadow-lg rounded-xl">
                      <button onClick={() => setIsFilterVisible(!isFilterVisible)} className="w-full flex justify-between items-center font-bold text-lg text-slate-800 p-6">
                          <span>フィルター & 並び替え</span>
                          <ChevronUpIcon className={`w-6 h-6 transform transition-transform ${isFilterVisible ? '' : 'rotate-180'}`} />
                      </button>
                      <div className={`filter-content ${isFilterVisible ? 'open' : ''}`}>
                          <div className="p-6 pt-0 border-t border-slate-200">
                            <div className="space-y-4 pt-6">
                                <div>
                                    <Label htmlFor="keywordFilter">キーワード (顧客名, 案件名)</Label>
                                    <Input type="text" id="keywordFilter" name="keyword" value={filters.keyword} onChange={handleFilterChange} placeholder="キーワードで検索..." />
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div><Label>ステータス</Label><Select name="status" value={filters.status} onChange={handleFilterChange}>{STATUS_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}</Select></div>
                                    <div><Label>顧客種別</Label><Select name="customerCategory" value={filters.customerCategory} onChange={handleFilterChange}><option value="すべて">すべて</option>{CUSTOMER_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</Select></div>
                                    <div><Label>並び順</Label><Select name="sortKey" value={sortKey} onChange={e => setSortKey(e.target.value)}>{Object.entries(SORT_OPTIONS).map(([key, label]) => <option key={key} value={key}>{label}</option>)}</Select></div>
                                    <div className="flex items-end">
                                      <button onClick={handleResetFilters} className="w-full px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">リセット</button>
                                    </div>
                                </div>
                            </div>
                          </div>
                      </div>
                  </div>

                  <ProjectTable 
                      projects={filteredAndSortedProjects}
                      onViewDetails={setViewingProject}
                      onTaskToggle={handleTaskToggle}
                      onOpenMemo={setMemoModalProject}
                  />

                  <NewProjectModal 
                      isOpen={isModalOpen}
                      onClose={() => setIsModalOpen(false)}
                      onSaveProject={handleSaveProject}
                      editingProject={editingProject}
                  />
                  
                  <ProjectDetailModal
                      isOpen={!!viewingProject}
                      project={viewingProject}
                      onClose={() => setViewingProject(null)}
                      onEdit={handleEditProject}
                      onDelete={handleDeleteProject}
                      onCarryOver={handleCarryOver}
                      onSetLost={handleSetLost}
                      onUndoLost={handleUndoLost}
                  />

                   <ConfirmationModal 
                      isOpen={confirmation.isOpen}
                      title={confirmation.title}
                      message={confirmation.message}
                      onConfirm={confirmation.onConfirm}
                      onCancel={confirmation.onCancel}
                   />
                  <MemoModal
                      isOpen={!!memoModalProject}
                      project={memoModalProject}
                      onClose={() => setMemoModalProject(null)}
                      onSave={handleSaveMemo}
                  />
              </div>
          );
      };

      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>