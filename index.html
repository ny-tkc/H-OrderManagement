<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>受発注管理ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Simple transition for collapsible filter */
      .filter-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out;
      }
      .filter-content.open {
        max-height: 600px; /* Adjust as needed */
      }
      .goal-success-toast {
        animation: fadeInOut 3s ease-in-out;
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
      .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: white;
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useMemo, useCallback, useEffect, useRef } = React;

      // --- CONSTANTS ---
      const TASKS = [
        'ネゴ提案', '見積提示', '注文作成', '本体受注', 'S/U発注', '日程調整',
        '現地調整', '検収作成', '保守作成', '検収送付', '保守送付'
      ];
      const CUSTOMER_CATEGORIES = ['会計事務所', '関与先'];
      const DIVISIONS = ['新規', 'リプレイス', 'その他'];
      const PRODUCT_TYPES = ['PC', 'スキャナ', 'プリンタ', 'ルータ', 'SI', 'その他'];
      const PAYMENT_TYPES = ['COD', 'MIST', '後払い'];
      const SETUP_OPTIONS = ['なし', 'あり (SCG)', 'あり (Q&A)', 'あり (NSG)'];
      const MAINTENANCE_OPTIONS = ['あり', 'なし'];
      const STATUS_OPTIONS = ['すべて', '受注済み', '完了済み', '失注'];
      const SORT_OPTIONS = {
        'registrationDate_desc': '登録日が新しい順',
        'registrationDate_asc': '登録日が古い順',
        'mainAmount_desc': '金額が高い順',
        'mainAmount_asc': '金額が低い順',
      };
      
      const JAPANESE_HOLIDAYS = new Set([
        // 2025
        '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-24', '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13', '2025-11-03', '2025-11-24',
        // 2026
        '2026-01-01', '2026-01-12', '2026-02-11', '2026-02-23', '2026-03-20', '2026-04-29', '2026-05-03', '2026-05-04', '2026-05-05', '2026-05-6', '2026-07-20', '2026-08-11', '2026-09-21', '2026-09-22', '2026-09-23', '2026-10-12', '2026-11-03', '2026-11-23',
      ]);

      // --- HELPERS ---
      const getVisibleTasks = (project) => {
          let visible = [...TASKS];
          if (project.division === '新規') {
              visible = visible.filter(t => t !== 'ネゴ提案');
          }
           if (project.setup === 'なし') {
              visible = visible.filter(t => t !== 'S/U発注' && t !== '日程調整' && t !== '現地調整');
          }
          if (project.paymentType === 'COD' && project.setup === 'なし') {
              visible = visible.filter(t => t !== '検収作成' && t !== '検収送付');
          }
          if (project.maintenance === 'なし') {
              visible = visible.filter(t => t !== '保守作成' && t !== '保守送付');
          }
          return visible;
      };

      const getProjectStatusCategory = (project) => {
        if (project.isLost) return 4; // 失注
        const visibleTasks = getVisibleTasks(project);
        const isCompleted = visibleTasks.every(task => project.tasks[task]);
        if (isCompleted) return 3; // 完了
        if (project.tasks['本体受注']) return 2; // 進行中 (受注)
        return 1; // 進行中 (未受注)
      };

      // --- ICONS ---
      const PlusIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>);
      const XIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>);
      const ChevronUpIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>);
      const EditIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>);
      const TrashIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.033-2.134H8.033C6.91 2.75 6 3.704 6 4.884v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>);
      const ArrowCircleRightIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>);
      const NoSymbolIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" /></svg>);
      const DocumentTextIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>);
      const CheckIcon = ({ className = "w-6 h-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>);
      const RefreshIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.664 0l3.181-3.183m-3.181-4.991-3.181-3.183a8.25 8.25 0 0 0-11.664 0l-3.181 3.183" /></svg>);
      const ChatBubbleLeftEllipsisIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" /></svg>);
      const QuestionMarkCircleIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>);
      const CogIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226.55-.22 1.156-.22 1.706 0 .55.22 1.02.684 1.11 1.226l.08 1.161c.66.126 1.28.368 1.86.704l1.042-.46c.516-.228 1.1-.118 1.462.322.362.44.334 1.076-.082 1.462l-.46 1.042c.336.58.578 1.2.704 1.86l1.16.08c.542.09.998.56 1.226 1.11.22.55.22 1.156 0 1.706-.228.55-.684 1.02-1.226 1.11l-1.16.08c-.126.66-.368 1.28-.704 1.86l.46 1.042c.416.386.444 1.022.082 1.462-.362.44-.946.55-1.462.322l-1.042-.46c-.58.336-1.2.578-1.86.704l-.08 1.161c-.09.542-.56 1.007-1.11 1.226-.55-.22-1.156-.22-1.706 0-.55-.22-1.02-.684-1.11-1.226l-.08-1.161c-.66-.126-1.28-.368-1.86-.704l-1.042.46c-.516-.228-1.1.118-1.462-.322-.362-.44-.334-1.076.082-1.462l.46-1.042c-.336-.58-.578-1.2-.704-1.86l-1.16-.08c-.542-.09-.998-.56-1.226-1.11-.22-.55-.22-1.156 0-1.706.228-.55.684-1.02-1.226 1.11l1.16-.08c.126-.66.368-1.28.704-1.86l-.46-1.042c-.416-.386-.444-1.022-.082-1.462.362-.44.946-.55 1.462-.322l1.042.46c.58-.336 1.2-.578 1.86-.704l.08-1.161zM12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" /></svg>);
      const ArrowDownTrayIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>);
      const ArrowUpTrayIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>);
      const ExclamationTriangleIcon = ({className}) => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>);

      // --- HOOKS ---
      const usePeriodCalculator = () => {
          const generatePeriods = () => {
              const periods = [];
              const startYear = 2025; // R7
              const startPeriod = 60;
              for (let i = 0; i < 5; i++) {
                  const year = startYear + i;
                  const period = startPeriod + i;
                  const reiwaYear = year - 2018;
                  periods.push({
                      label: `第${period}期 上期 (R${reiwaYear}年10月～R${reiwaYear + 1}年3月)`,
                      value: `${period}-1`,
                      startDate: new Date(year, 9, 1),
                      endDate: new Date(year + 1, 2, 31),
                  });
                  periods.push({
                      label: `第${period}期 下期 (R${reiwaYear + 1}年4月～R${reiwaYear + 1}年9月)`,
                      value: `${period}-2`,
                      startDate: new Date(year + 1, 3, 1),
                      endDate: new Date(year + 1, 8, 30),
                  });
              }
              return periods;
          };

          const allPeriods = useMemo(generatePeriods, []);
          
          const getCurrentPeriod = useCallback(() => {
              const now = new Date();
              return allPeriods.find(p => now >= p.startDate && now <= p.endDate) || allPeriods[0];
          }, [allPeriods]);

          const [selectedPeriod, setSelectedPeriod] = useState(getCurrentPeriod().value);
          
          return { periods: allPeriods, selectedPeriod, setSelectedPeriod, getCurrentPeriod };
      }

      // --- COMPONENTS ---
      const Input = (props) => <input {...props} className="block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const Select = (props) => <select {...props} className="block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const Label = ({htmlFor, children, className}) => <label htmlFor={htmlFor} className={`block text-sm font-medium text-slate-700 mb-1 ${className}`}>{children}</label>;
      
      const ModalInput = React.forwardRef((props, ref) => <input {...props} ref={ref} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />);
      const ModalSelect = (props) => <select {...props} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const ModalTextarea = (props) => <textarea {...props} rows="3" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />;
      const ModalLabel = ({htmlFor, children}) => <label htmlFor={htmlFor} className="block text-sm font-medium text-slate-700">{children}</label>;

      const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
          if (!isOpen) return null;
          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                      <div className="p-6">
                          <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                          <p className="mt-2 text-sm text-slate-600 whitespace-pre-wrap">{message}</p>
                      </div>
                      <div className="px-6 py-4 bg-slate-50 flex justify-end items-center space-x-3 rounded-b-lg">
                          <button onClick={onCancel} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition">キャンセル</button>
                          <button onClick={onConfirm} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">実行する</button>
                      </div>
                  </div>
              </div>
          );
      };

      const OrderDateModal = ({ isOpen, defaultDate, onClose, onConfirm }) => {
        const [date, setDate] = useState(defaultDate);

        useEffect(() => {
            if (isOpen) {
                setDate(defaultDate || new Date().toISOString().split('T')[0]);
            }
        }, [isOpen, defaultDate]);

        if (!isOpen) return null;

        const handleConfirm = () => {
            if (!date) {
                alert('受注日を入力してください。');
                return;
            }
            onConfirm(date);
        };

        return (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
                <div className="bg-white rounded-lg shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                    <div className="p-6">
                        <h3 className="text-lg font-bold text-slate-800">受注日の登録</h3>
                        <p className="mt-2 text-sm text-slate-600">本体受注を完了にするには、受注日を登録してください。</p>
                        <div className="mt-4">
                            <ModalLabel htmlFor="orderDateInput">受注日</ModalLabel>
                            <ModalInput type="date" id="orderDateInput" value={date} onChange={e => setDate(e.target.value)} />
                        </div>
                    </div>
                    <div className="px-6 py-4 bg-slate-50 flex justify-end items-center space-x-3 rounded-b-lg">
                        <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition">キャンセル</button>
                        <button onClick={handleConfirm} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">登録する</button>
                    </div>
                </div>
            </div>
        );
      };
      
      const GuideModal = ({ isOpen, onClose }) => {
        if (!isOpen) return null;

        const GuideSection = ({ title, children }) => (
            <div className="mb-6">
                <h4 className="text-lg font-bold text-slate-800 mb-2 border-b-2 border-blue-500 pb-1">{title}</h4>
                <div className="text-sm text-slate-600 space-y-2">{children}</div>
            </div>
        );

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all" onClick={e => e.stopPropagation()}>
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><QuestionMarkCircleIcon className="w-6 h-6 text-blue-600" />使い方ガイド</h3>
                        <button onClick={onClose} className="p-1 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><XIcon className="w-5 h-5" /></button>
                    </div>
                    <div className="p-6 max-h-[70vh] overflow-y-auto">
                        <GuideSection title="1. 案件の登録">
                            <p>画面右上の「+ 新規案件」ボタンから新しい案件を登録します。</p>
                            <p>顧客種別を選択後、詳細情報を入力します。「商品種別」などを選択すると、関連する項目（支払区分、保守契約など）が自動で入力されることがあります。</p>
                        </GuideSection>
                        <GuideSection title="2. タスク管理">
                            <p>案件一覧の各タスクは、クリックすることで状態を変更できます。</p>
                            <ul className="list-disc list-inside space-y-1 pl-2">
                                <li><span className="inline-block w-4 h-4 rounded-full bg-slate-200 align-middle mr-2"></span>: 未完了のタスク</li>
                                <li><span className="inline-flex w-4 h-4 rounded-full bg-blue-500 items-center justify-center align-middle mr-2"><CheckIcon className="w-3 h-3 text-white"/></span>: 完了したタスク</li>
                            </ul>
                            <p>「本体受注」タスクをクリックすると、受注日の入力が求められます。この日付が分析グラフの集計に使われます。</p>
                        </GuideSection>
                         <GuideSection title="3. メモ機能">
                            <p>案件一覧のメモアイコン <ChatBubbleLeftEllipsisIcon className="w-4 h-4 inline-block" /> をクリックすると、その案件に関するメモを自由に残せます。</p>
                            <p>メモが入力されている案件は、アイコンが青色で表示されます。</p>
                        </GuideSection>
                        <GuideSection title="4. 案件の詳細と操作">
                            <p>案件一覧の右端にある詳細アイコン <DocumentTextIcon className="w-4 h-4 inline-block" /> をクリックすると、案件の詳細情報を確認できます。</p>
                            <p>詳細画面からは、編集、削除、失注処理、次期への繰越などの操作が可能です。</p>
                        </GuideSection>
                        <GuideSection title="5. ダッシュボードと目標管理">
                            <p>画面上部のダッシュボードでは、現在の進捗状況を視覚的に確認できます。「本体受注」や「S/U発注」タスクを完了させると「受注金額」に反映されます。</p>
                            <p>「目標金額」の「登録」ボタンから半期の目標金額と内訳を設定し、達成率を管理することができます。</p>
                        </GuideSection>
                         <GuideSection title="6. 絞り込みと並び替え">
                            <p>「フィルター & 並び替え」セクションを開くと、キーワードやステータスで案件を絞り込んだり、登録日や金額で並び替えたりすることができます。</p>
                        </GuideSection>
                         <GuideSection title="7. 分析タブ">
                            <p>「分析」タブでは、期間内の受注状況をグラフで確認できます。ダッシュボードも表示され、全体の状況を把握しながら分析できます。</p>
                            <p>月別グラフの「受注金額」は、登録された「受注日」を元に集計されます。「保守締結率」の円グラフでは、主要商品の保守契約状況を確認できます。</p>
                        </GuideSection>
                         <GuideSection title="8. 設定（バックアップと復元）">
                             <p>画面右上の設定アイコン <CogIcon className="w-4 h-4 inline-block" /> から、データの管理ができます。</p>
                             <p>「エクスポート」で全データをファイルに保存でき、「インポート」でファイルからデータを復元できます。これにより、PCの買い替え時などにデータを移行できます。</p>
                             <p>「すべてのデータを削除」は、アプリケーション内の全データを消去します。操作は元に戻せないのでご注意ください。</p>
                         </GuideSection>
                    </div>
                    <div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end">
                        <button onClick={onClose} className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">閉じる</button>
                    </div>
                </div>
            </div>
        );
      };

      const SettingsModal = ({ isOpen, onClose, onBackup, onRestore, onDeleteAll }) => {
          const fileInputRef = useRef(null);

          if (!isOpen) return null;

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
                  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all" onClick={e => e.stopPropagation()}>
                      <div className="p-6 border-b border-slate-200 flex justify-between items-center">
                          <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><CogIcon className="w-6 h-6 text-slate-700" />設定</h3>
                          <button onClick={onClose} className="p-1 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><XIcon className="w-5 h-5" /></button>
                      </div>
                      <div className="p-6 space-y-8">
                          <section>
                              <h4 className="text-lg font-semibold text-slate-800 mb-2">バックアップと復元</h4>
                              <p className="text-sm text-slate-600 mb-4">
                                  全期間のデータをファイルとして保存（エクスポート）したり、ファイルから復元（インポート）したりします。PCの買い替え時などのデータ移行にご利用ください。
                              </p>
                              <div className="flex gap-4">
                                  <button onClick={onBackup} className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-sm hover:bg-blue-700 transition-colors">
                                      <ArrowDownTrayIcon className="w-5 h-5" />
                                      <span>エクスポート</span>
                                  </button>
                                  <input type="file" ref={fileInputRef} onChange={onRestore} hidden accept=".json" />
                                  <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition-colors">
                                      <ArrowUpTrayIcon className="w-5 h-5" />
                                      <span>インポート</span>
                                  </button>
                              </div>
                          </section>
                          <section className="p-4 border-2 border-red-300 bg-red-50 rounded-lg">
                              <h4 className="text-lg font-semibold text-red-800 flex items-center gap-2"><ExclamationTriangleIcon className="w-5 h-5" />データ管理</h4>
                              <p className="text-sm text-red-700 my-2">
                                  アプリケーション内のすべてのデータを完全に削除します。この操作は元に戻すことができず、バックアップがない限りデータを復元できません。
                              </p>
                              <button onClick={onDeleteAll} className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg shadow-sm hover:bg-red-700 transition-colors">
                                  すべてのデータを削除する
                              </button>
                          </section>
                      </div>
                      <div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end">
                          <button onClick={onClose} className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">閉じる</button>
                      </div>
                  </div>
              </div>
          );
      };

      const NewProjectModal = ({ isOpen, onClose, onSaveProject, editingProject }) => {
        const isEditMode = !!editingProject;
        const dateInputRef = useRef(null);

        const getInitialState = (project = null) => {
            if (project) return { setupAmount: 0, isLost: false, ...project };
            return {
                category: CUSTOMER_CATEGORIES[0], clientName: '', officeName: '', registrationDate: new Date().toISOString().split('T')[0],
                mainAmount: 0, projectName: '', division: DIVISIONS[0], productType: PRODUCT_TYPES[0],
                paymentType: PAYMENT_TYPES[0], setup: SETUP_OPTIONS[0], maintenance: MAINTENANCE_OPTIONS[0], memo: '', setupAmount: 0, isLost: false, orderDate: null,
            };
        };
        
        const [formState, setFormState] = useState(getInitialState(editingProject));
        const [step, setStep] = useState(1);

        const availableProductTypes = useMemo(() => {
            if (formState.category === '関与先') return PRODUCT_TYPES.filter(p => p !== 'ルータ' && p !== 'SI');
            return PRODUCT_TYPES;
        }, [formState.category]);

        const availablePaymentTypes = useMemo(() => {
            if (formState.category === '関与先') return PAYMENT_TYPES.filter(p => p !== 'MIST');
            return PAYMENT_TYPES;
        }, [formState.category]);

        const availableSetupOptions = useMemo(() => {
            if (formState.category === '会計事務所') return SETUP_OPTIONS.filter(s => s !== 'あり (Q&A)');
            if (formState.category === '関与先') return SETUP_OPTIONS.filter(s => s !== 'あり (NSG)');
            return SETUP_OPTIONS;
        }, [formState.category]);
        
        useEffect(() => { 
            if (isOpen) {
                const initialState = getInitialState(editingProject);
                setFormState(initialState);
                setStep(isEditMode ? 2 : 1);
            }
        }, [isOpen, editingProject]);
        
        useEffect(() => {
          if (isOpen && step === 2) {
            setTimeout(() => dateInputRef.current?.focus(), 100);
          }
        }, [isOpen, step]);
        
        useEffect(() => {
            const updates = {};
            if (!availableProductTypes.includes(formState.productType)) {
                updates.productType = availableProductTypes[0];
            }
            if (!availablePaymentTypes.includes(formState.paymentType)) {
                updates.paymentType = availablePaymentTypes[0];
            }
            if (!availableSetupOptions.includes(formState.setup)) {
                updates.setup = availableSetupOptions[0];
            }
            if (Object.keys(updates).length > 0) {
                setFormState(prev => ({ ...prev, ...updates }));
            }
        }, [formState.category, availableProductTypes, availablePaymentTypes, availableSetupOptions]);

        const handleCategorySelect = (category) => {
            setFormState(prev => ({...getInitialState(), category}));
            setStep(2);
        };

        const handleAmountChange = (e) => {
            const { name, value } = e.target;
            const sanitizedValue = value.replace(/,/g, '');
            if (/^\d*$/.test(sanitizedValue)) {
                const numValue = sanitizedValue === '' ? 0 : parseInt(sanitizedValue, 10);
                setFormState(prev => ({ ...prev, [name]: numValue }));
            }
        };

        const handleChange = (e) => {
            const { name, value, type } = e.target;
            setFormState(prevFormState => {
                const newFormState = { ...prevFormState, [name]: value };

                if (name === 'productType') {
                    if (value === 'PC' || value === 'プリンタ') {
                        newFormState.paymentType = 'COD'; newFormState.maintenance = 'あり';
                    } else if (value === 'スキャナ') {
                        newFormState.paymentType = 'COD'; newFormState.setup = 'なし'; newFormState.maintenance = 'なし'; newFormState.setupAmount = 0;
                    } else if (value === 'ルータ' && prevFormState.category === '会計事務所') {
                        newFormState.paymentType = 'MIST'; newFormState.setup = 'あり (NSG)'; newFormState.setupAmount = 30000;
                    } else if (value === 'SI' && prevFormState.category === '会計事務所') {
                        newFormState.paymentType = 'MIST'; newFormState.setup = 'なし'; newFormState.maintenance = 'なし'; newFormState.setupAmount = 0;
                    }
                } else if (name === 'setup') {
                    if (prevFormState.category === '関与先' && value === 'あり (SCG)') {
                        newFormState.setupAmount = 20000;
                    } else if (value === 'あり (Q&A)') {
                        newFormState.setupAmount = 15000;
                    } else if (value === 'あり (NSG)') {
                        newFormState.setupAmount = 30000;
                    } else if (value === 'なし') {
                        newFormState.setupAmount = 0;
                    }
                }
                return newFormState;
            });
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!formState.registrationDate || !formState.projectName || !formState.clientName) { alert('登録日、顧客名、案件名は必須です。'); return; }
            onSaveProject(formState); 
            onClose();
        };

        if (!isOpen) return null;
        
        const showSetupAmount = formState.setup !== 'なし';

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" onClick={onClose}>
                {step === 1 && !isEditMode && (
                     <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all p-8 text-center" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-slate-800 mb-2">新規案件の登録</h3>
                        <p className="text-slate-600 mb-8">まず、顧客種別を選択してください</p>
                        <div className="flex justify-center gap-4">
                            <button onClick={() => handleCategorySelect(CUSTOMER_CATEGORIES[0])} className="w-40 h-16 text-lg font-semibold text-blue-600 bg-blue-50 border-2 border-blue-500 rounded-lg hover:bg-blue-100 transition-colors">{CUSTOMER_CATEGORIES[0]}</button>
                            <button onClick={() => handleCategorySelect(CUSTOMER_CATEGORIES[1])} className="w-40 h-16 text-lg font-semibold text-blue-600 bg-blue-50 border-2 border-blue-500 rounded-lg hover:bg-blue-100 transition-colors">{CUSTOMER_CATEGORIES[1]}</button>
                        </div>
                    </div>
                )}
                {step === 2 && (
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-slate-200 flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800">{isEditMode ? '案件の編集' : `新規案件の登録 (${formState.category})`}</h3><button onClick={onClose} className="p-1 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><XIcon className="w-5 h-5" /></button></div>
                        <form onSubmit={handleSubmit}>
                            <div className="p-6 max-h-[70vh] overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <div><ModalLabel htmlFor="registrationDate">登録日 <span className="text-red-500">*</span></ModalLabel><ModalInput type="date" name="registrationDate" id="registrationDate" value={formState.registrationDate} onChange={handleChange} ref={dateInputRef} required /></div>
                                <div></div>
                                <div><ModalLabel htmlFor="clientName">顧客名 <span className="text-red-500">*</span></ModalLabel><ModalInput type="text" name="clientName" id="clientName" value={formState.clientName} onChange={handleChange} required /></div>
                                {formState.category === '関与先' ? (
                                    <div><ModalLabel htmlFor="officeName">事務所名</ModalLabel><ModalInput type="text" name="officeName" id="officeName" value={formState.officeName || ''} onChange={handleChange} /></div>
                                ) : ( <div></div> )}
                                <div className="md:col-span-2"><ModalLabel htmlFor="projectName">案件名 <span className="text-red-500">*</span></ModalLabel><ModalInput type="text" name="projectName" id="projectName" value={formState.projectName} onChange={handleChange} required /></div>
                                <div><ModalLabel htmlFor="mainAmount">本体金額 (税抜)</ModalLabel><ModalInput type="text" name="mainAmount" id="mainAmount" value={formState.mainAmount.toLocaleString()} onChange={handleAmountChange} /></div>
                                <div><ModalLabel htmlFor="division">区分</ModalLabel><ModalSelect name="division" id="division" value={formState.division} onChange={handleChange}>{DIVISIONS.map(d => <option key={d}>{d}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="productType">商品種別</ModalLabel><ModalSelect name="productType" id="productType" value={formState.productType} onChange={handleChange}>{availableProductTypes.map(p => <option key={p}>{p}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="paymentType">支払区分</ModalLabel><ModalSelect name="paymentType" id="paymentType" value={formState.paymentType} onChange={handleChange}>{availablePaymentTypes.map(p => <option key={p}>{p}</option>)}</ModalSelect></div>
                                <div><ModalLabel htmlFor="setup">セットアップ</ModalLabel><ModalSelect name="setup" id="setup" value={formState.setup} onChange={handleChange}>{availableSetupOptions.map(s => <option key={s}>{s}</option>)}</ModalSelect></div>
                                {showSetupAmount && <div><ModalLabel htmlFor="setupAmount">セットアップ金額 (税抜)</ModalLabel><ModalInput type="text" name="setupAmount" id="setupAmount" value={formState.setupAmount.toLocaleString()} onChange={handleAmountChange} readOnly={formState.setup !== 'あり (SCG)'} /></div>}
                                <div><ModalLabel htmlFor="maintenance">保守契約</ModalLabel><ModalSelect name="maintenance" id="maintenance" value={formState.maintenance} onChange={handleChange}>{MAINTENANCE_OPTIONS.map(m => <option key={m}>{m}</option>)}</ModalSelect></div>
                                <div className="md:col-span-2"><ModalLabel htmlFor="memo">メモ</ModalLabel><ModalTextarea name="memo" id="memo" value={formState.memo} onChange={handleChange} /></div>
                            </div>
                            <div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end items-center space-x-3"><button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">キャンセル</button><button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 transition">{isEditMode ? '更新する' : '登録する'}</button></div>
                        </form>
                    </div>
                )}
            </div>
        );
      };

      const DetailItem = ({ label, value, className = "" }) => (<div className={`flex flex-col ${className}`}><dt className="text-xs text-slate-500">{label}</dt><dd className="text-sm text-slate-900 mt-1 break-words">{value || 'ー'}</dd></div>);

      const ProjectDetailModal = ({ isOpen, project, onClose, onEdit, onDelete, onCarryOver, onSetLost, onUndoLost }) => {
        if (!isOpen || !project) return null;

        const setupAmount = project.setupAmount || 0;
        const totalAmount = project.mainAmount + setupAmount;

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all" onClick={e => e.stopPropagation()}>
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="text-xl font-bold text-slate-800">案件詳細</h3>
                        <button onClick={onClose} className="p-1 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><XIcon className="w-5 h-5" /></button>
                    </div>
                    <div className="p-6 max-h-[70vh] overflow-y-auto">
                        <div className="mb-6 pb-6 border-b border-slate-200">
                             <p className="text-xs text-slate-500">顧客名 {project.officeName && `/ 事務所名`}</p>
                             <h4 className="text-2xl font-bold text-slate-900">
                                 {project.clientName}
                                 {project.officeName && <span className="text-lg text-slate-600 font-medium ml-2">/ {project.officeName}</span>}
                            </h4>
                             <p className="text-xs text-slate-500 mt-4">案件名</p>
                             <p className="text-lg text-slate-700 mt-1">{project.projectName}</p>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-y-6 gap-x-4">
                            <DetailItem label="顧客種別" value={project.category} />
                            <DetailItem label="区分" value={project.division} />
                            <DetailItem label="商品種別" value={project.productType} />
                            <DetailItem label="支払区分" value={project.paymentType} />
                            <DetailItem label="セットアップ" value={project.setup} />
                            <DetailItem label="保守契約" value={project.maintenance} />
                            <DetailItem label="登録日" value={new Date(project.registrationDate).toLocaleDateString('ja-JP')} />
                            <DetailItem label="受注日" value={project.orderDate ? new Date(project.orderDate).toLocaleDateString('ja-JP') : 'ー'} />
                            <div className="flex flex-col">
                               <dt className="text-xs text-slate-500">金額内訳</dt>
                               <dd className="text-sm text-slate-900 mt-1">
                                    <div>本体: {project.mainAmount.toLocaleString()}円</div>
                                    <div>セットアップ: {setupAmount.toLocaleString()}円</div>
                                    <div className="font-bold border-t border-slate-200 mt-1 pt-1">合計: {totalAmount.toLocaleString()}円</div>
                               </dd>
                            </div>
                            <DetailItem label="メモ" value={project.memo} className="col-span-2 md:col-span-3" />
                        </div>
                    </div>
                     <div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex items-center gap-4 text-slate-600">
                        <button onClick={() => { onEdit(project); onClose(); }} className="flex items-center gap-2 hover:text-blue-600"><EditIcon className="w-5 h-5" /><span>編集</span></button>
                        {project.isLost ? (
                            <button onClick={() => onUndoLost(project.id)} className="flex items-center gap-2 hover:text-green-600"><RefreshIcon className="w-5 h-5" /><span>失注を取り消す</span></button>
                        ) : (
                            <button onClick={() => onSetLost(project.id)} className="flex items-center gap-2 hover:text-orange-600"><NoSymbolIcon className="w-5 h-5" /><span>失注</span></button>
                        )}
                        <button onClick={() => onDelete(project.id)} className="flex items-center gap-2 hover:text-red-600"><TrashIcon className="w-5 h-5" /><span>削除</span></button>
                        <button onClick={() => onCarryOver(project)} className="flex items-center gap-2 hover:text-green-600"><ArrowCircleRightIcon className="w-5 h-5" /><span>繰り越し</span></button>
                        <div className="flex-grow"></div>
                        <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">閉じる</button>
                    </div>
                </div>
            </div>
        );
      };

      const MemoModal = ({ isOpen, project, onClose, onSave }) => {
          const [memo, setMemo] = useState('');

          useEffect(() => {
              if (project) {
                  setMemo(project.memo || '');
              }
          }, [project]);

          if (!isOpen || !project) return null;

          const handleSave = () => {
              onSave(project, memo);
              onClose();
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                      <div className="p-6">
                          <h3 className="text-lg font-bold text-slate-800">{project.clientName} - メモ</h3>
                          <p className="text-sm text-slate-500 mt-1 truncate">{project.projectName}</p>
                          <ModalTextarea value={memo} onChange={e => setMemo(e.target.value)} className="mt-4" rows="5" />
                      </div>
                      <div className="px-6 py-4 bg-slate-50 flex justify-end items-center space-x-3 rounded-b-lg">
                          <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition">キャンセル</button>
                          <button onClick={handleSave} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">保存する</button>
                      </div>
                  </div>
              </div>
          );
      };

      const TaskStatus = ({ status, onClick, disabled }) => {
          const baseClasses = "w-6 h-6 rounded-full flex items-center justify-center transition-all duration-300 ease-in-out";
          const interactiveClasses = disabled ? 'cursor-not-allowed opacity-60' : 'cursor-pointer transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400';

          switch (status) {
              case 'completed':
                  return (
                      <button onClick={onClick} disabled={disabled} title="完了" className={`${baseClasses} ${interactiveClasses} bg-blue-500 shadow`}>
                          <CheckIcon className="w-4 h-4 text-white" />
                      </button>
                  );
              case 'pending':
                  return (
                      <button onClick={onClick} disabled={disabled} title="未完了" className={`${baseClasses} ${interactiveClasses} bg-slate-200 hover:bg-slate-300`}></button>
                  );
              case 'skipped':
                   return (
                      <div title="対象外" className={`${baseClasses}`}></div>
                  );
              default:
                  return <div className={baseClasses}></div>;
          }
      };
      
      const HankoStamp = ({ status }) => {
        if (!status) return <div className="w-10 h-10 flex-shrink-0"></div>;

        const styles = {
            '受注': 'text-red-600 border-red-600',
            '完了': 'text-blue-600 border-blue-600',
            '失注': 'text-slate-500 border-slate-500',
        };
        
        return (
            <div className={`flex-shrink-0 flex items-center justify-center w-10 h-10 border-2 rounded-full font-serif font-bold text-sm transform -rotate-12 ${styles[status]}`}>
                {status}
            </div>
        );
      };

      const ProjectCard = ({ project, onViewDetails, onTaskToggle, onOpenMemo }) => {
          const totalAmount = project.mainAmount + (project.setupAmount || 0);
          
          const visibleTasks = useMemo(() => getVisibleTasks(project), [project]);
          
          const isLost = project.isLost;
          const isCompleted = !isLost && visibleTasks.every(task => project.tasks[task]);
          const isOrdered = !isLost && !isCompleted && project.tasks['本体受注'];

          let status = null;
          if (isLost) status = '失注';
          else if (isCompleted) status = '完了';
          else if (isOrdered) status = '受注';

          return (
            <tr className={`hover:bg-slate-50 transition-colors duration-200 ${project.isLost ? 'opacity-60 grayscale' : ''}`}>
                <td className="p-2 pl-4">
                  <div className="flex items-center gap-3 min-w-0">
                      <HankoStamp status={status} />
                      <div className="flex-grow min-w-0">
                          <h3 className="font-bold text-slate-900 truncate text-base">
                              {project.clientName}
                              {project.officeName && <span className="text-slate-500 text-xs font-normal ml-1">/ {project.officeName}</span>}
                          </h3>
                          <p className="text-slate-500 text-xs mt-1 truncate">{project.projectName}</p>
                      </div>
                  </div>
                </td>
                <td className="p-2 text-slate-600 text-center">{new Date(project.registrationDate).toLocaleDateString('ja-JP')}</td>
                <td className="p-2 font-semibold text-slate-800 text-right">
                  <div>{totalAmount.toLocaleString()}円</div>
                  {(project.setupAmount || 0) > 0 && (
                      <div className="text-xs text-slate-500 font-normal">内, S/U: {project.setupAmount.toLocaleString()}円</div>
                  )}
                </td>
                 <td className="p-2 text-center">
                    <button onClick={() => onOpenMemo(project)} className={`p-2 rounded-full transition-colors ${project.memo ? 'text-blue-600 bg-blue-100 hover:bg-blue-200' : 'text-slate-400 hover:bg-slate-200 hover:text-slate-600'}`} title="メモ">
                        <ChatBubbleLeftEllipsisIcon className="w-5 h-5" />
                    </button>
                </td>
                <td></td>{/* Spacer */}{TASKS.map((task) => {
                    const isVisible = visibleTasks.includes(task);
                    const isCompleted = project.tasks[task];
                    
                    let taskStatus = 'pending';
                    if (!isVisible) taskStatus = 'skipped';
                    else if (isCompleted) taskStatus = 'completed';
                    
                    const isDisabled = project.isLost;

                    return (
                        <td key={task} className="text-center">
                            <div className="flex justify-center items-center h-full">
                                <TaskStatus
                                    status={taskStatus}
                                    onClick={() => onTaskToggle(project, task)}
                                    disabled={isDisabled}
                                />
                            </div>
                        </td>
                    );
                })}
                <td className="p-2 text-center">
                    <button onClick={() => onViewDetails(project)} className="p-2 text-slate-500 hover:bg-slate-200 hover:text-slate-800 rounded-full transition-colors" title="詳細を表示">
                        <DocumentTextIcon className="w-5 h-5" />
                    </button>
                </td>
            </tr>
          );
      };

      const ProjectTable = ({ projects, onViewDetails, onTaskToggle, onOpenMemo }) => {
        return (
            <div className="bg-white shadow-lg rounded-xl overflow-x-auto mt-6" style={{maxHeight: '70vh'}}>
                <table className="w-full min-w-[1320px] border-collapse text-sm">
                    <thead className="sticky-header">
                        <tr className="border-b-2 border-slate-300 text-xs font-semibold text-slate-600">
                            <th className="p-2 pl-4 text-left w-[25%]">顧客・案件名</th>
                            <th className="p-2 text-center w-[8%]">登録日</th>
                            <th className="p-2 text-right w-[10%]">金額 (総額)</th>
                            <th className="p-2 text-center w-[5%]">メモ</th>
                            <th className="w-[2%]"></th>{/* Spacer */}{TASKS.map(task => (
                                <th key={task} className="p-1 text-center text-[10px] leading-tight break-words w-[4%]">{task}</th>
                            ))}
                            <th className="p-2 text-center w-[5%]">詳細</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-200">
                        {projects.length > 0 ? (
                            projects.map(project => <ProjectCard key={project.id} {...{ project, onViewDetails, onTaskToggle, onOpenMemo }} />)
                        ) : (
                             <tr>
                                 <td colSpan={TASKS.length + 6} className="p-12 text-center text-slate-500">
                                    <h3 className="text-lg font-semibold">案件がありません</h3>
                                    <p className="mt-2 text-sm">右上の「新規案件」ボタンから新しい案件を登録してください。</p>
                                 </td>
                             </tr>
                        )}
                    </tbody>
                </table>
            </div>
        );
      };

      const DashboardCard = ({ title, value, subtext, colorClass = "text-slate-900" }) => (
          <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm h-full flex flex-col">
              <div className="flex-grow">
                <div className="text-sm text-slate-500">{title}</div>
                <div className={`text-3xl font-bold mt-1 ${colorClass}`}>{value}</div>
              </div>
              {subtext && <div className="text-xs text-slate-500 mt-1">{subtext}</div>}
          </div>
      );

      const AchievementStamp = () => (
          <div className="absolute -top-3 -right-3 z-10">
              <div className="flex items-center justify-center w-20 h-20 border-4 border-red-500 bg-white/70 backdrop-blur-sm rounded-full font-serif font-bold text-red-500 transform rotate-12">
                  <span className="text-3xl">達成</span>
              </div>
          </div>
      );

      const ProgressBar = ({ percentage }) => {
        const cappedPercentage = Math.min(percentage, 100);
        const colorClasses = [
            'bg-red-500',    // 0-9%
            'bg-orange-500', // 10-19%
            'bg-amber-500',  // 20-29%
            'bg-yellow-500', // 30-39%
            'bg-lime-500',   // 40-49%
            'bg-green-500',  // 50-59%
            'bg-emerald-500',// 60-69%
            'bg-teal-500',   // 70-79%
            'bg-cyan-500',   // 80-89%
            'bg-sky-500',    // 90-99%
            'bg-blue-600',   // 100%
        ];
        const colorIndex = Math.floor(cappedPercentage / 10);
        const colorClass = colorClasses[Math.min(colorIndex, colorClasses.length - 1)];

        return (
            <div className="w-full bg-slate-200 rounded-full h-4">
                <div
                    className={`h-4 rounded-full transition-all duration-500 ease-out ${colorClass}`}
                    style={{ width: `${cappedPercentage}%` }}
                ></div>
            </div>
        );
      };
      
      const GoalModal = ({ isOpen, goal, onClose, onSave }) => {
          const getInitialState = (g) => {
              if (g && typeof g === 'object' && g !== null) {
                  return {
                      total: g.total || 0,
                      hardware_firm: g.hardware_firm || 0,
                      hardware_client: g.hardware_client || 0,
                      si: g.si || 0,
                  };
              }
              return { total: 10000000, hardware_firm: 0, hardware_client: 0, si: 0 };
          };

          const [formState, setFormState] = useState(getInitialState(goal));

          useEffect(() => {
              if (isOpen) {
                  setFormState(getInitialState(goal));
              }
          }, [isOpen, goal]);

          const handleAmountChange = (e) => {
              const { name, value } = e.target;
              const sanitizedValue = value.replace(/,/g, '');
              if (/^\d*$/.test(sanitizedValue)) {
                  const numValue = sanitizedValue === '' ? 0 : parseInt(sanitizedValue, 10);
                  setFormState(prev => ({ ...prev, [name]: numValue }));
              }
          };

          const hardwareTotal = formState.hardware_firm + formState.hardware_client;
          const breakdownTotal = hardwareTotal + formState.si;
          const difference = formState.total - breakdownTotal;

          const handleSubmit = () => {
              onSave(formState);
              onClose();
          };

          if (!isOpen) return null;

          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
                  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all" onClick={e => e.stopPropagation()}>
                      <div className="p-6 border-b border-slate-200 flex justify-between items-center">
                          <h3 className="text-xl font-bold text-slate-800">目標金額の登録</h3>
                          <button onClick={onClose} className="p-1 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><XIcon className="w-5 h-5" /></button>
                      </div>
                      <div className="p-6 space-y-4">
                          <div>
                              <ModalLabel htmlFor="total">総額目標</ModalLabel>
                              <ModalInput type="text" name="total" id="total" value={formState.total.toLocaleString()} onChange={handleAmountChange} />
                          </div>
                          <div className="p-4 border border-slate-200 rounded-lg space-y-4">
                              <h4 className="text-md font-semibold text-slate-700">内訳</h4>
                              <div>
                                  <ModalLabel>ハードウェア</ModalLabel>
                                  <div className="pl-4 mt-2 space-y-3 border-l-2 border-slate-200">
                                      <div>
                                          <ModalLabel htmlFor="hardware_firm">会計事務所</ModalLabel>
                                          <ModalInput type="text" name="hardware_firm" id="hardware_firm" value={formState.hardware_firm.toLocaleString()} onChange={handleAmountChange} />
                                      </div>
                                      <div>
                                          <ModalLabel htmlFor="hardware_client">関与先</ModalLabel>
                                          <ModalInput type="text" name="hardware_client" id="hardware_client" value={formState.hardware_client.toLocaleString()} onChange={handleAmountChange} />
                                      </div>
                                      <div className="text-right text-sm">
                                          <span className="text-slate-500">ハードウェア合計: </span>
                                          <span className="font-semibold">{hardwareTotal.toLocaleString()}円</span>
                                      </div>
                                  </div>
                              </div>
                              <div>
                                  <ModalLabel htmlFor="si">SI・その他</ModalLabel>
                                  <ModalInput type="text" name="si" id="si" value={formState.si.toLocaleString()} onChange={handleAmountChange} />
                              </div>
                          </div>
                          <div className="p-4 bg-slate-50 rounded-lg flex justify-between items-center text-sm">
                              <div className="font-semibold text-slate-800">
                                  <span>内訳合計: </span>
                                  <span className="text-lg">{breakdownTotal.toLocaleString()}円</span>
                              </div>
                              <div className={`font-semibold text-right ${difference !== 0 ? 'text-red-600' : 'text-green-600'}`}>
                                  <div>差額</div>
                                  <div className="text-lg">{difference.toLocaleString()}円</div>
                              </div>
                          </div>
                          {difference !== 0 && <p className="text-xs text-center text-red-500">総額目標と内訳合計が一致していません。</p>}
                      </div>
                      <div className="p-6 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end items-center space-x-3">
                          <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">キャンセル</button>
                          <button type="button" onClick={handleSubmit} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 transition">登録する</button>
                      </div>
                  </div>
              </div>
          );
      };

      const Dashboard = ({ projects, goalAmount, setGoalAmount }) => {
          const [isGoalModalOpen, setIsGoalModalOpen] = useState(false);
          const [showSuccess, setShowSuccess] = useState(false);

          const stats = useMemo(() => {
              const allNonLostProjects = projects.filter(p => !p.isLost);
              
              const calcTotals = (projectList) => {
                  return projectList.reduce((sum, p) => sum + p.mainAmount + (p.setupAmount || 0), 0)
              };

              const calcOrderedTotals = (projectList) => {
                  return projectList.reduce((sum, p) => {
                      let projectOrderedAmount = 0;
                      if (p.tasks['本体受注']) projectOrderedAmount += p.mainAmount;
                      if (p.tasks['S/U発注']) projectOrderedAmount += (p.setupAmount || 0);
                      return sum + projectOrderedAmount;
                  }, 0);
              };
              
              const isSI = p => p.productType === 'SI' || p.productType === 'その他';
              
              const totalAmount = calcTotals(allNonLostProjects);
              const totalAmountFirm = calcTotals(allNonLostProjects.filter(p => p.category === '会計事務所' && !isSI(p)));
              const totalAmountClient = calcTotals(allNonLostProjects.filter(p => p.category === '関与先' && !isSI(p)));
              const totalAmountSI = calcTotals(allNonLostProjects.filter(p => isSI(p)));
              const totalSetupAmount = allNonLostProjects.reduce((sum, p) => sum + (p.setupAmount || 0), 0);

              const orderedAmount = calcOrderedTotals(allNonLostProjects);
              const orderedAmountFirm = calcOrderedTotals(allNonLostProjects.filter(p => p.category === '会計事務所' && !isSI(p)));
              const orderedAmountClient = calcOrderedTotals(allNonLostProjects.filter(p => p.category === '関与先' && !isSI(p)));
              const orderedAmountSI = calcOrderedTotals(allNonLostProjects.filter(p => isSI(p)));
              
              const orderedSetupAmount = allNonLostProjects.reduce((sum, p) => {
                 if (p.tasks['S/U発注']) return sum + (p.setupAmount || 0);
                 return sum;
              }, 0);

              const orderedProjects = allNonLostProjects.filter(p => p.tasks['本体受注'] || p.tasks['S/U発注']);
              const achievementRate = goalAmount.total > 0 ? (orderedAmount / goalAmount.total) * 100 : 0;

              return { 
                totalAmount, totalAmountFirm, totalAmountClient, totalAmountSI, totalSetupAmount,
                orderedAmount, orderedAmountFirm, orderedAmountClient, orderedAmountSI,
                orderedSetupAmount, achievementRate, 
                orderedProjectsCount: orderedProjects.length, totalProjectsCount: allNonLostProjects.length 
              };
          }, [projects, goalAmount]);
          
          const handleSaveGoal = (newGoal) => {
              setGoalAmount(newGoal);
              setShowSuccess(true);
              setTimeout(() => setShowSuccess(false), 3000);
          }
          
          const isGoalRegistered = goalAmount && goalAmount.total > 0;
          const hardwareGoalTotal = (goalAmount?.hardware_firm || 0) + (goalAmount?.hardware_client || 0);

          return (
            <>
              <div className="bg-slate-50/50 shadow-lg rounded-xl p-6 mb-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <DashboardCard 
                          title="対象総額" 
                          value={`${stats.totalAmount.toLocaleString()}円`} 
                          subtext={
                            <div>
                                <div className="flex justify-between items-baseline">
                                    <span>{stats.totalProjectsCount}件</span>
                                    <span className="font-normal">内, S/U: {stats.totalSetupAmount.toLocaleString()}円</span>
                                </div>
                                <div className="space-y-1 mt-1 border-t pt-1">
                                    <div>会: {stats.totalAmountFirm.toLocaleString()}円</div>
                                    <div>関: {stats.totalAmountClient.toLocaleString()}円</div>
                                    <div>SI: {stats.totalAmountSI.toLocaleString()}円</div>
                                </div>
                            </div>
                          } 
                          colorClass="text-indigo-600" 
                      />
                       <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm relative h-full flex flex-col">
                          {showSuccess && <div className="absolute top-2 right-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded goal-success-toast">目標金額を登録しました！</div>}
                          <div className="flex-grow">
                            <div className="text-sm text-slate-500">目標金額</div>
                            {isGoalRegistered ? (
                              <>
                                <div className="text-3xl font-bold mt-1 text-green-600">{goalAmount.total.toLocaleString()}<span className="text-lg ml-1">円</span></div>
                                <div className="text-xs text-slate-500 mt-2 space-y-1 border-t pt-2">
                                   <p>ハードウェア: {hardwareGoalTotal.toLocaleString()}円</p>
                                   <p>SI・その他: {(goalAmount.si || 0).toLocaleString()}円</p>
                                </div>
                              </>
                            ) : (
                              <div className="text-3xl font-bold mt-1 text-slate-400">未登録</div>
                            )}
                          </div>
                          <div className="flex justify-end mt-2">
                            <button onClick={() => setIsGoalModalOpen(true)} className="px-3 py-1 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100">{isGoalRegistered ? '編集' : '登録'}</button>
                          </div>
                      </div>
                      <DashboardCard 
                          title="受注金額" 
                          value={`${stats.orderedAmount.toLocaleString()}円`} 
                          colorClass="text-blue-600" 
                          subtext={
                            <div>
                                <div className="flex justify-between items-baseline">
                                    <span>{stats.orderedProjectsCount}件</span>
                                    <span className="font-normal">内, S/U: {stats.orderedSetupAmount.toLocaleString()}円</span>
                                </div>
                                <div className="space-y-1 mt-1 border-t pt-1">
                                    <div>会: {stats.orderedAmountFirm.toLocaleString()}円</div>
                                    <div>関: {stats.orderedAmountClient.toLocaleString()}円</div>
                                    <div>SI: {stats.orderedAmountSI.toLocaleString()}円</div>
                                </div>
                            </div>
                          } 
                      />
                      <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm h-full flex flex-col relative">
                          <div className="flex-grow flex flex-col justify-center items-center">
                              <div className="text-sm text-slate-500">目標達成率</div>
                              <div className="text-5xl font-bold text-blue-600">{`${stats.achievementRate.toFixed(1)}%`}</div>
                          </div>
                          {stats.achievementRate >= 100 && <AchievementStamp />}
                      </div>
                  </div>
                  <div className="mt-6">
                      <div className="flex justify-end items-baseline text-sm font-medium text-slate-600 mb-1">
                          <span>{stats.orderedAmount.toLocaleString()}円</span>
                          <span className="text-slate-400 mx-1">/</span>
                          <span>{(isGoalRegistered ? goalAmount.total : 0).toLocaleString()}円</span>
                      </div>
                      <ProgressBar percentage={stats.achievementRate} />
                  </div>
              </div>
              <GoalModal 
                isOpen={isGoalModalOpen}
                goal={goalAmount}
                onClose={() => setIsGoalModalOpen(false)}
                onSave={handleSaveGoal}
              />
            </>
          );
      };

      const ChartComponent = ({ type, data, options }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);
    
        useEffect(() => {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            if (!canvasRef.current) return;
            
            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
                type: type,
                data: data,
                options: options
            });
            
            return () => {
                if (chartRef.current) {
                    chartRef.current.destroy();
                }
            };
        }, [type, data, options]);
    
        return <canvas ref={canvasRef}></canvas>;
      };

      const AnalysisView = ({ projects, period, goalAmount }) => {
        const [maintenanceFilter, setMaintenanceFilter] = useState('全体');
        const [monthlyFilter, setMonthlyFilter] = useState('すべて');
        
        const monthlyTarget = useMemo(() => {
          if (!period || !goalAmount || goalAmount.total === 0) return 0;
          
          const start = new Date(period.startDate);
          const end = new Date(period.endDate);
          let months = (end.getFullYear() - start.getFullYear()) * 12;
          months -= start.getMonth();
          months += end.getMonth();
          const monthsInPeriod = months <= 0 ? 1 : months + 1;

          let targetTotal = 0;
          switch (monthlyFilter) {
              case 'すべて': targetTotal = goalAmount.total || 0; break;
              case '会計事務所': targetTotal = goalAmount.hardware_firm || 0; break;
              case '関与先': targetTotal = goalAmount.hardware_client || 0; break;
              case 'SI': targetTotal = goalAmount.si || 0; break;
              default: targetTotal = 0;
          }
          return targetTotal > 0 ? targetTotal / monthsInPeriod : 0;
        }, [goalAmount, period, monthlyFilter]);

        const analysisData = useMemo(() => {
          const nonLostProjects = projects.filter(p => !p.isLost);

          // Generate all month labels for the period
          const allMonthLabels = [];
          if (period) {
              let currentDate = new Date(period.startDate);
              const endDate = new Date(period.endDate);
              while (currentDate <= endDate) {
                  allMonthLabels.push(`${currentDate.getFullYear()}/${String(currentDate.getMonth() + 1).padStart(2, '0')}`);
                  currentDate.setMonth(currentDate.getMonth() + 1);
              }
          }

          const hardwareTypes = ['PC', 'スキャナ', 'プリンタ', 'ルータ'];
          const filteredMonthlyProjects = nonLostProjects.filter(p => {
              if (monthlyFilter === 'すべて') return true;
              if (monthlyFilter === '会計事務所') return p.category === '会計事務所' && hardwareTypes.includes(p.productType);
              if (monthlyFilter === '関与先') return p.category === '関与先' && hardwareTypes.includes(p.productType);
              if (monthlyFilter === 'SI') return p.productType === 'SI' || p.productType === 'その他';
              return true;
          });

          const monthlyOrdered = allMonthLabels.reduce((acc, label) => ({ ...acc, [label]: 0 }), {});
          const monthlyOrderedCounts = allMonthLabels.reduce((acc, label) => ({ ...acc, [label]: 0 }), {});

          filteredMonthlyProjects.forEach(p => {
              const registrationDate = new Date(p.registrationDate);
              const registrationMonthKey = `${registrationDate.getFullYear()}/${String(registrationDate.getMonth() + 1).padStart(2, '0')}`;
              const orderDate = p.orderDate ? new Date(p.orderDate) : null;
              
              let projectOrderedAmount = 0;
              if (p.tasks['本体受注']) projectOrderedAmount += p.mainAmount;
              if (p.tasks['S/U発注']) projectOrderedAmount += (p.setupAmount || 0);

              if (projectOrderedAmount > 0) {
                const monthKey = orderDate ? `${orderDate.getFullYear()}/${String(orderDate.getMonth() + 1).padStart(2, '0')}` : registrationMonthKey;
                if(monthlyOrdered.hasOwnProperty(monthKey)) {
                    monthlyOrdered[monthKey] += projectOrderedAmount;
                    monthlyOrderedCounts[monthKey]++;
                }
              }
          });

          const monthlyData = {
              labels: allMonthLabels,
              datasets: [
                  { label: '受注金額', data: allMonthLabels.map(k => monthlyOrdered[k]), counts: allMonthLabels.map(k => monthlyOrderedCounts[k]), backgroundColor: '#3b82f6', order: 2 },
                  {
                    type: 'line',
                    label: '目標ライン',
                    data: allMonthLabels.map(() => monthlyTarget),
                    borderColor: '#f97316',
                    backgroundColor: '#f97316',
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0,
                    borderDash: [5, 5],
                    order: 1,
                  }
              ]
          };

          const byProduct = nonLostProjects.reduce((acc, p) => {
              const key = p.productType;
              if (!acc[key]) acc[key] = { orderedTotal: 0, orderedCount: 0 };
              
              let orderedAmount = 0;
              if (p.tasks['本体受注']) orderedAmount += p.mainAmount;
              // S/U amount is not by product, so we exclude it here.
              
              if (orderedAmount > 0) {
                  acc[key].orderedTotal += orderedAmount;
                  acc[key].orderedCount++;
              }
              return acc;
          }, {});
          
          const sortedProductEntries = Object.entries(byProduct).sort(([, a], [, b]) => b.orderedTotal - a.orderedTotal);
          
          const productData = {
              labels: sortedProductEntries.map(([label]) => label),
              datasets: [
                  { label: '受注金額', data: sortedProductEntries.map(([, { orderedTotal }]) => orderedTotal), counts: sortedProductEntries.map(([, { orderedCount }]) => orderedCount), backgroundColor: '#3b82f6' },
              ]
          };

          return { monthly: monthlyData, product: productData };
        }, [projects, period, monthlyFilter, monthlyTarget]);

         const maintenanceChartData = useMemo(() => {
            const relevantProductTypes = ['PC', 'プリンタ', 'ルータ'];
            const filteredProjects = projects
                .filter(p => p.tasks['本体受注'])
                .filter(p => {
                    if (maintenanceFilter === '全体') {
                        return relevantProductTypes.includes(p.productType);
                    }
                    return p.productType === maintenanceFilter;
                });
            
            const withMaintenance = filteredProjects.filter(p => p.maintenance === 'あり').length;
            const withoutMaintenance = filteredProjects.length - withMaintenance;
            const total = filteredProjects.length;

            return {
                labels: ['保守あり', '保守なし'],
                datasets: [{
                    data: [withMaintenance, withoutMaintenance],
                    backgroundColor: ['#3b82f6', '#94a3b8'],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }],
                total,
            };
        }, [projects, maintenanceFilter]);

        const categorySalesData = useMemo(() => {
            const data = { '会計事務所': 0, '関与先': 0, 'SI': 0 };
            
            projects.filter(p => !p.isLost).forEach(p => {
                let orderedAmount = 0;
                if (p.tasks['本体受注']) orderedAmount += p.mainAmount;
                if (p.tasks['S/U発注']) orderedAmount += (p.setupAmount || 0);
                
                if (orderedAmount > 0) {
                    if (p.productType === 'SI' || p.productType === 'その他') {
                        data['SI'] += orderedAmount;
                    } else if (p.category === '会計事務所') {
                        data['会計事務所'] += orderedAmount;
                    } else if (p.category === '関与先') {
                        data['関与先'] += orderedAmount;
                    }
                }
            });

            const total = data['会計事務所'] + data['関与先'] + data['SI'];

            return {
                labels: ['会計事務所', '関与先', 'SI'],
                datasets: [{
                    data: [data['会計事務所'], data['関与先'], data['SI']],
                    backgroundColor: ['#3b82f6', '#10b981', '#f97316'],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }],
                total,
            };
        }, [projects]);


        if (projects.filter(p => !p.isLost).length === 0) {
          return (
            <div className="bg-white shadow-lg rounded-xl p-12 text-center text-slate-500 mt-6">
              <h3 className="text-lg font-semibold">分析対象のデータがありません</h3>
              <p className="mt-2 text-sm">案件を登録してください。</p>
            </div>
          );
        }

        const tooltipCallbacks = {
          label: (context) => {
            let label = context.dataset.label || '';
            let value = context.parsed.y;
             if (context.chart.options.indexAxis === 'y') {
                value = context.parsed.x;
            }
            if (context.dataset.type === 'line') {
                return `${label}: ${value.toLocaleString()}円`
            }
            if (value === null || typeof value === 'undefined') {
                return `${label}: 0円`;
            }
            return `${label}: ${Number(value).toLocaleString()}円`;
          },
          afterLabel: (context) => {
            if (context.dataset.counts && context.dataset.type !== 'line') {
              const count = context.dataset.counts[context.dataIndex];
              return `件数: ${count}件`;
            }
            return null;
          },
        };

        const commonChartOptions = {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: true, position: 'top', onClick: null }, tooltip: { callbacks: tooltipCallbacks, mode: 'index', intersect: false } },
          interaction: { intersect: false, mode: 'index' },
          scales: { x: { stacked: false }, y: { stacked: false, ticks: { callback: value => `${(value / 10000)}万円` } } },
        };
        
        const horizontalChartOptions = { ...commonChartOptions, indexAxis: 'y', scales: { y: { stacked: false }, x: { stacked: false, ticks: { callback: value => `${(value / 10000)}万円` } } } };

        const maintenanceDoughnutOptions = {
            responsive: true, maintainAspectRatio: false, cutout: '70%',
            plugins: { legend: { display: true, position: 'bottom', onClick: null }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw}件` } } }
        };

        const categoryDoughnutOptions = {
            responsive: true, maintainAspectRatio: false, cutout: '70%', rotation: -90,
            plugins: { 
                legend: { display: true, position: 'bottom', onClick: null }, 
                tooltip: { 
                    callbacks: { 
                        label: (c) => {
                            const total = c.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((c.raw / total) * 100).toFixed(1) : 0;
                            return `${c.label}: ${c.raw.toLocaleString()}円 (${percentage}%)`;
                        }
                    }
                } 
            }
        };

        return (
          <div className="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-3 bg-white shadow-lg rounded-xl p-6">
                <div className="flex flex-wrap justify-between items-center gap-2 mb-4">
                  <h3 className="font-bold text-slate-800">月次売上分析</h3>
                   <div className="flex p-1 space-x-1 bg-slate-200/70 rounded-lg">
                      {['すべて', '会計事務所', '関与先', 'SI'].map(item => (
                          <button key={item} onClick={() => setMonthlyFilter(item)} className={`px-3 py-1 text-xs font-semibold transition-colors rounded-md ${monthlyFilter === item ? 'bg-white text-blue-600 shadow' : 'text-slate-600 hover:bg-slate-100'}`}>
                              {item}
                          </button>
                      ))}
                  </div>
                </div>
                <div className="h-80"><ChartComponent type="bar" data={analysisData.monthly} options={{...commonChartOptions, scales: { x: { stacked: false, offset: false }, y: { stacked: false, ticks: { callback: value => `${(value / 10000)}万円` } } } }} /></div>
              </div>

              <div className="bg-white shadow-lg rounded-xl p-6">
                <h3 className="font-bold text-slate-800 mb-4">商品種別ごとの売上分析</h3>
                <div className="h-80"><ChartComponent type="bar" data={analysisData.product} options={horizontalChartOptions} /></div>
              </div>

              <div className="bg-white shadow-lg rounded-xl p-6">
                <h3 className="font-bold text-slate-800">保守締結率</h3>
                <div className="flex justify-center my-2">
                    <div className="flex p-1 space-x-1 bg-slate-200/70 rounded-lg">
                        {['全体', 'PC', 'プリンタ', 'ルータ'].map(item => (
                            <button key={item} onClick={() => setMaintenanceFilter(item)} className={`px-4 py-1 text-xs font-semibold transition-colors rounded-md ${maintenanceFilter === item ? 'bg-white text-blue-600 shadow' : 'text-slate-600 hover:bg-slate-100'}`}>
                                {item}
                            </button>
                        ))}
                    </div>
                </div>
                {maintenanceChartData.total > 0 ? (
                    <div className="h-80 relative flex justify-center items-center -mt-4">
                        <ChartComponent type="doughnut" data={maintenanceChartData} options={maintenanceDoughnutOptions} />
                        <div className="absolute text-center pointer-events-none">
                            <div className="text-3xl font-bold text-slate-800">
                                {((maintenanceChartData.datasets[0].data[0] / maintenanceChartData.total) * 100).toFixed(1)}%
                            </div>
                            <div className="text-sm text-slate-500">締結率 ({maintenanceChartData.datasets[0].data[0]} / {maintenanceChartData.total}件)</div>
                        </div>
                    </div>
                ) : (
                    <div className="h-80 flex items-center justify-center text-slate-500">対象の受注済み案件がありません</div>
                )}
              </div>
              <div className="bg-white shadow-lg rounded-xl p-6">
                <h3 className="font-bold text-slate-800 mb-4">売上構成 (受注)</h3>
                {categorySalesData.total > 0 ? (
                    <div className="h-80 relative flex justify-center items-center -mt-4">
                        <ChartComponent type="doughnut" data={categorySalesData} options={categoryDoughnutOptions} />
                        <div className="absolute text-center pointer-events-none">
                            <div className="text-2xl font-bold text-slate-800">
                                {categorySalesData.total.toLocaleString()}円
                            </div>
                            <div className="text-sm text-slate-500">受注総額</div>
                        </div>
                    </div>
                ) : (
                    <div className="h-80 flex items-center justify-center text-slate-500">対象の案件がありません</div>
                )}
              </div>
          </div>
        );
      };

      const App = () => {
          const periodData = usePeriodCalculator();
          const { selectedPeriod, setSelectedPeriod, getCurrentPeriod, periods } = periodData;
          
          const defaultGoal = { total: 10000000, hardware_firm: 0, hardware_client: 0, si: 0 };

          const [allData, setAllData] = useState(() => {
              try {
                  const savedData = localStorage.getItem('allPeriodData');
                  return savedData ? JSON.parse(savedData) : {};
              } catch (error) {
                  console.error("Error loading all data from localStorage", error); return {};
              }
          });

          // One-time migration from old data structure
          useEffect(() => {
            const oldProjectsJSON = localStorage.getItem('projects');
            if (oldProjectsJSON) {
              try {
                const oldGoalJSON = localStorage.getItem('goalAmount');
                const currentPeriodValue = getCurrentPeriod().value;
                const oldGoalAmount = oldGoalJSON ? Number(JSON.parse(oldGoalJSON)) : 10000000;
                
                setAllData(prevData => {
                  const migratedData = {
                      projects: JSON.parse(oldProjectsJSON).map(p => ({ orderDate: null, ...p })),
                      goalAmount: {
                          total: oldGoalAmount,
                          hardware_firm: 0,
                          hardware_client: 0,
                          si: 0
                      }
                  };
                  if (!prevData[currentPeriodValue]) {
                      return { ...prevData, [currentPeriodValue]: migratedData };
                  }
                  return prevData;
                });

                localStorage.removeItem('projects');
                localStorage.removeItem('goalAmount');
              } catch (error) {
                console.error("Failed to migrate data", error);
              }
            }
          }, [getCurrentPeriod]);

          useEffect(() => {
              try {
                  localStorage.setItem('allPeriodData', JSON.stringify(allData));
              } catch (error) { console.error("Error saving all data to localStorage", error); }
          }, [allData]);

          const { projects, goalAmount } = useMemo(() => {
              const data = allData[selectedPeriod] || { projects: [], goalAmount: defaultGoal };
               if (typeof data.goalAmount === 'number' || data.goalAmount === null || data.goalAmount === undefined) {
                 return {
                    ...data,
                    goalAmount: { total: Number(data.goalAmount) || 0, hardware_firm: 0, hardware_client: 0, si: 0 }
                };
              }
              return data;
          }, [allData, selectedPeriod]);

          const setProjectsForCurrentPeriod = (update) => {
              setAllData(prevAllData => {
                  const currentData = prevAllData[selectedPeriod] || { projects: [], goalAmount: defaultGoal };
                  const newProjects = typeof update === 'function' ? update(currentData.projects) : update;
                  return {
                      ...prevAllData,
                      [selectedPeriod]: { ...currentData, projects: newProjects },
                  };
              });
          };

          const setGoalAmountForCurrentPeriod = (newGoal) => {
              setAllData(prevAllData => {
                  const currentData = prevAllData[selectedPeriod] || { projects: [], goalAmount: defaultGoal };
                  return {
                      ...prevAllData,
                      [selectedPeriod]: { ...currentData, goalAmount: newGoal },
                  };
              });
          };

          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingProject, setEditingProject] = useState(null);
          const [viewingProject, setViewingProject] = useState(null);
          const [memoModalProject, setMemoModalProject] = useState(null);
          const [isGuideModalOpen, setIsGuideModalOpen] = useState(false);
          const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
          const [orderDateModalState, setOrderDateModalState] = useState({ isOpen: false, project: null, taskName: null });

          const initialFilters = { keyword: '', status: 'すべて', customerCategory: 'すべて' };
          const [filters, setFilters] = useState(initialFilters);
          const [sortKey, setSortKey] = useState('registrationDate_asc');
          const [isFilterVisible, setIsFilterVisible] = useState(false);
          const [confirmation, setConfirmation] = useState({ isOpen: false, title: '', message: '', onConfirm: null, onCancel: null });
          const [activeTab, setActiveTab] = useState('details');
          
          const handleSaveProject = (projectData) => {
              setProjectsForCurrentPeriod(prevProjects => {
                  if (projectData.id) { // Update existing
                      return prevProjects.map(p => p.id === projectData.id ? { ...p, ...projectData } : p);
                  } else { // Add new
                      const newProject = { 
                          ...projectData, 
                          id: Date.now(), 
                          tasks: TASKS.reduce((acc, task) => ({...acc, [task]: false}), {}) 
                      };
                      return [...prevProjects, newProject];
                  }
              });
              setEditingProject(null);
          };

          const handleEditProject = (project) => {
              setEditingProject(project);
              setIsModalOpen(true);
          };

          const handleDeleteProject = (projectId) => {
              setConfirmation({
                  isOpen: true, title: '案件の削除', message: 'この案件を完全に削除します。この操作は元に戻せません。よろしいですか？',
                  onConfirm: () => {
                      setProjectsForCurrentPeriod(prev => prev.filter(p => p.id !== projectId));
                      setViewingProject(null);
                      setConfirmation({ isOpen: false });
                  },
                  onCancel: () => setConfirmation({ isOpen: false })
              });
          };
          
          const handleSetLost = (projectId) => {
              setConfirmation({
                  isOpen: true, title: '失注の確認', message: 'この案件を「失注」としてマークしますか？タスクの変更ができなくなります。',
                  onConfirm: () => {
                      setProjectsForCurrentPeriod(prev => prev.map(p => p.id === projectId ? {...p, isLost: true} : p));
                      setViewingProject(prev => prev && prev.id === projectId ? {...prev, isLost: true} : prev);
                      setConfirmation({ isOpen: false });
                  },
                  onCancel: () => setConfirmation({ isOpen: false })
              });
          };

          const handleUndoLost = (projectId) => {
              setConfirmation({
                  isOpen: true, title: '失注の取り消し', message: 'この案件を「失注」から戻しますか？タスクの変更が可能になります。',
                  onConfirm: () => {
                      setProjectsForCurrentPeriod(prev => prev.map(p => p.id === projectId ? {...p, isLost: false} : p));
                      setViewingProject(null);
                      setConfirmation({ isOpen: false });
                  },
                  onCancel: () => setConfirmation({ isOpen: false })
              });
          };
          
          const handleSaveOrderDate = (date) => {
            const { project, taskName } = orderDateModalState;
            setProjectsForCurrentPeriod(prevProjects => prevProjects.map(p => {
                if (p.id === project.id) {
                    return { ...p, tasks: { ...p.tasks, [taskName]: true }, orderDate: date };
                }
                return p;
            }));
            setOrderDateModalState({ isOpen: false, project: null, taskName: null });
          };

          const handleTaskToggle = (project, taskName) => {
              if (project.isLost) return;

              if (taskName === '本体受注' && !project.tasks[taskName]) {
                  setOrderDateModalState({ isOpen: true, project: project, taskName: taskName });
                  return; 
              }

              setProjectsForCurrentPeriod(prevProjects => prevProjects.map(p => {
                  if (p.id === project.id) {
                      const newTasks = { ...p.tasks, [taskName]: !p.tasks[taskName] };
                      if (taskName === '本体受注' && p.tasks[taskName]) { // unchecking
                          return { ...p, tasks: newTasks, orderDate: null };
                      }
                      return { ...p, tasks: newTasks };
                  }
                  return p;
              }));
          };

          const handleCarryOver = (project) => {
              setConfirmation({
                isOpen: true, title: '案件の繰越', message: `${project.clientName}の案件をコピーして繰り越しますか？`,
                onConfirm: () => {
                    const newProject = {
                        ...project, id: Date.now(), registrationDate: new Date().toISOString().split('T')[0],
                        tasks: TASKS.reduce((acc, task) => ({...acc, [task]: false}), {}),
                        isLost: false, orderDate: null, memo: `(繰越元: ${project.registrationDate} ${project.projectName})\n${project.memo}`
                    };
                    setProjectsForCurrentPeriod(prev => [...prev, newProject]);
                    setConfirmation({isOpen: false});
                    setViewingProject(null);
                },
                onCancel: () => setConfirmation({isOpen: false})
              });
          };

          const handleSaveMemo = (project, newMemo) => {
            handleSaveProject({ ...project, memo: newMemo });
          };

          const handleFilterChange = (e) => {
              setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
          };

          const handleResetFilters = () => {
              setFilters(initialFilters);
              setSortKey('registrationDate_asc');
          };

          const handleBackup = () => {
              try {
                  const data = localStorage.getItem('allPeriodData');
                  if (!data || Object.keys(JSON.parse(data)).length === 0) {
                      alert('バックアップするデータがありません。');
                      return;
                  }
                  const blob = new Blob([data], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  const date = new Date().toISOString().split('T')[0];
                  a.href = url;
                  a.download = `order-management-backup-${date}.json`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                  setIsSettingsModalOpen(false);
              } catch (error) {
                  console.error('バックアップに失敗しました:', error);
                  alert('バックアップ処理中にエラーが発生しました。');
              }
          };

          const handleRestore = (event) => {
              const file = event.target.files[0];
              if (!file) return;

              const reader = new FileReader();
              reader.onload = (e) => {
                  try {
                      const text = e.target.result;
                      const data = JSON.parse(text);
                      if (typeof data !== 'object' || data === null || Array.isArray(data)) {
                          throw new Error('無効なファイル形式です。');
                      }
                      setConfirmation({
                          isOpen: true,
                          title: 'データの復元',
                          message: '現在のすべてのデータをバックアップファイルの内容で上書きします。\nこの操作は元に戻せません。よろしいですか？',
                          onConfirm: () => {
                              localStorage.setItem('allPeriodData', JSON.stringify(data));
                              setAllData(data);
                              setConfirmation({ isOpen: false });
                              setIsSettingsModalOpen(false);
                              alert('データの復元が完了しました。ページがリロードされます。');
                              window.location.reload();
                          },
                          onCancel: () => setConfirmation({ isOpen: false })
                      });
                  } catch (error) {
                      console.error('復元に失敗しました:', error);
                      alert(`復元に失敗しました: ${error.message}`);
                  } finally {
                    event.target.value = null;
                  }
              };
              reader.readAsText(file);
          };

          const handleDeleteAllData = () => {
              setConfirmation({
                  isOpen: true,
                  title: '全データの削除',
                  message: 'すべての期間のすべての案件データを完全に削除します。\nこの操作は元に戻すことができず、バックアップがない限りデータを復元できません。\n本当によろしいですか？',
                  onConfirm: () => {
                      localStorage.removeItem('allPeriodData');
                      setAllData({});
                      setConfirmation({ isOpen: false });
                      setIsSettingsModalOpen(false);
                      alert('すべてのデータを削除しました。');
                  },
                  onCancel: () => setConfirmation({ isOpen: false })
              });
          };

          const filteredAndSortedProjects = useMemo(() => {
              let result = projects.filter(p => {
                    const keywordMatch = filters.keyword === '' || 
                        p.clientName.toLowerCase().includes(filters.keyword.toLowerCase()) || 
                        p.projectName.toLowerCase().includes(filters.keyword.toLowerCase()) ||
                        (p.officeName && p.officeName.toLowerCase().includes(filters.keyword.toLowerCase()));

                    const visibleTasks = getVisibleTasks(p);
                    const isCompleted = visibleTasks.every(task => p.tasks[task]);

                    const statusMatch = filters.status === 'すべて' ? true :
                        filters.status === '受注済み' ? p.tasks['本体受注'] && !isCompleted && !p.isLost :
                        filters.status === '完了済み' ? isCompleted && !p.isLost :
                        filters.status === '失注' ? p.isLost : false;
                    
                    const categoryMatch = filters.customerCategory === 'すべて' || p.category === filters.customerCategory;
                    
                    return keywordMatch && statusMatch && categoryMatch;
              });

              result.sort((a, b) => {
                  const categoryA = getProjectStatusCategory(a);
                  const categoryB = getProjectStatusCategory(b);

                  if (categoryA !== categoryB) {
                      return categoryA - categoryB;
                  }
                  
                  const [key, order] = sortKey.split('_');
                  const valA = key === 'mainAmount' ? a.mainAmount + (a.setupAmount || 0) : a[key];
                  const valB = key === 'mainAmount' ? b.mainAmount + (b.setupAmount || 0) : b[key];
                  if (valA < valB) return order === 'asc' ? -1 : 1;
                  if (valA > valB) return order === 'asc' ? 1 : -1;
                  return 0;
              });
              return result;
          }, [projects, filters, sortKey]);

          const TabButton = ({ tabName, label }) => {
            const isActive = activeTab === tabName;
            const classes = `px-6 py-2 text-sm font-semibold transition-colors rounded-md ${isActive ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-600 hover:bg-slate-100'}`;
            return <button onClick={() => setActiveTab(tabName)} className={classes}>{label}</button>;
          };
          
          const currentPeriodObject = useMemo(() => periods.find(p => p.value === selectedPeriod), [periods, selectedPeriod]);

          return (
              <div className="container mx-auto p-4 md:p-8 max-w-full">
                  <header className="flex flex-wrap items-center justify-between gap-y-4 mb-6">
                      <div className="flex items-center gap-3">
                        <h1 className="text-3xl font-bold text-slate-900">受発注管理ツール</h1>
                        <button onClick={() => setIsGuideModalOpen(true)} className="text-slate-400 hover:text-blue-600 transition-colors" title="使い方ガイド">
                            <QuestionMarkCircleIcon className="w-7 h-7" />
                        </button>
                      </div>
                      <div className="flex items-center gap-4">
                        <button onClick={() => setIsSettingsModalOpen(true)} className="p-2 text-slate-500 hover:bg-slate-200 hover:text-slate-800 rounded-full transition-colors" title="設定">
                            <CogIcon className="w-6 h-6" />
                        </button>
                        <div>
                            <Label htmlFor="periodSelect" className="sr-only">対象期間</Label>
                            <Select id="periodSelect" value={selectedPeriod} onChange={e => setSelectedPeriod(e.target.value)}>
                                {periods.map(p => <option key={p.value} value={p.value}>{p.label}</option>)}
                            </Select>
                        </div>
                        <button onClick={() => { setEditingProject(null); setIsModalOpen(true); }} className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                            <PlusIcon className="w-5 h-5" />
                            <span>新規案件</span>
                        </button>
                      </div>
                  </header>

                   <Dashboard 
                        projects={projects} 
                        goalAmount={goalAmount} 
                        setGoalAmount={setGoalAmountForCurrentPeriod} 
                      />
                  
                   <nav className="flex justify-center mb-6">
                        <div className="flex p-1 space-x-1 bg-slate-200/70 rounded-lg border border-slate-300/50">
                            <TabButton tabName="details" label="明細" />
                            <TabButton tabName="analysis" label="分析" />
                        </div>
                   </nav>

                  {activeTab === 'details' && (
                    <>
                      <div className="bg-white shadow-lg rounded-xl">
                          <button onClick={() => setIsFilterVisible(!isFilterVisible)} className="w-full flex justify-between items-center font-bold text-lg text-slate-800 p-6">
                              <span>フィルター & 並び替え</span>
                              <ChevronUpIcon className={`w-6 h-6 transform transition-transform ${isFilterVisible ? '' : 'rotate-180'}`} />
                          </button>
                          <div className={`filter-content ${isFilterVisible ? 'open' : ''}`}>
                              <div className="p-6 pt-0 border-t border-slate-200">
                                <div className="space-y-4 pt-6">
                                    <div>
                                        <Label htmlFor="keywordFilter">キーワード (顧客名, 事務所名, 案件名)</Label>
                                        <Input type="text" id="keywordFilter" name="keyword" value={filters.keyword} onChange={handleFilterChange} placeholder="キーワードで検索..." />
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div><Label>ステータス</Label><Select name="status" value={filters.status} onChange={handleFilterChange}>{STATUS_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}</Select></div>
                                        <div><Label>顧客種別</Label><Select name="customerCategory" value={filters.customerCategory} onChange={handleFilterChange}><option value="すべて">すべて</option>{CUSTOMER_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</Select></div>
                                        <div><Label>並び順</Label><Select name="sortKey" value={sortKey} onChange={e => setSortKey(e.target.value)}>{Object.entries(SORT_OPTIONS).map(([key, label]) => <option key={key} value={key}>{label}</option>)}</Select></div>
                                        <div className="flex items-end">
                                          <button onClick={handleResetFilters} className="w-full px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition">リセット</button>
                                        </div>
                                    </div>
                                </div>
                              </div>
                          </div>
                      </div>

                      <ProjectTable 
                          projects={filteredAndSortedProjects}
                          onViewDetails={setViewingProject}
                          onTaskToggle={handleTaskToggle}
                          onOpenMemo={setMemoModalProject}
                      />
                    </>
                  )}

                  {activeTab === 'analysis' && (
                     <AnalysisView projects={projects} period={currentPeriodObject} goalAmount={goalAmount} />
                  )}

                  <NewProjectModal 
                      isOpen={isModalOpen}
                      onClose={() => setIsModalOpen(false)}
                      onSaveProject={handleSaveProject}
                      editingProject={editingProject}
                  />
                  
                  <ProjectDetailModal
                      isOpen={!!viewingProject}
                      project={viewingProject}
                      onClose={() => setViewingProject(null)}
                      onEdit={handleEditProject}
                      onDelete={handleDeleteProject}
                      onCarryOver={handleCarryOver}
                      onSetLost={handleSetLost}
                      onUndoLost={handleUndoLost}
                  />

                   <ConfirmationModal 
                      isOpen={confirmation.isOpen}
                      title={confirmation.title}
                      message={confirmation.message}
                      onConfirm={confirmation.onConfirm}
                      onCancel={confirmation.onCancel}
                   />
                  <MemoModal
                      isOpen={!!memoModalProject}
                      project={memoModalProject}
                      onClose={() => setMemoModalProject(null)}
                      onSave={handleSaveMemo}
                  />
                  <OrderDateModal
                      isOpen={orderDateModalState.isOpen}
                      defaultDate={orderDateModalState.project?.orderDate}
                      onClose={() => setOrderDateModalState({ isOpen: false, project: null, taskName: null })}
                      onConfirm={handleSaveOrderDate}
                  />
                   <GuideModal 
                      isOpen={isGuideModalOpen} 
                      onClose={() => setIsGuideModalOpen(false)} 
                   />
                   <SettingsModal
                       isOpen={isSettingsModalOpen}
                       onClose={() => setIsSettingsModalOpen(false)}
                       onBackup={handleBackup}
                       onRestore={handleRestore}
                       onDeleteAll={handleDeleteAllData}
                   />
              </div>
          );
      };

      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>